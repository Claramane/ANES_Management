# 安全指南

## 🔒 敏感資訊處理規範

> **適用對象**：麻醉科護理班表管理系統
> **安全等級**：醫療資訊系統

### 禁止事項
- ❌ 不得在代碼中硬編碼任何密碼、API密鑰或連線字串
- ❌ 不得將包含敏感資訊的檔案提交到版本控制
- ❌ 不得在commit訊息中包含敏感資訊
- ❌ 不得在文檔中暴露真實的密碼或主機位址

### 安全最佳實踐

#### 1. 環境變數使用
所有敏感配置應使用環境變數：
```bash
# 正確做法
export DATABASE_URL="postgresql://user:password@host:port/db"
export SECRET_KEY="your-secret-key"

# 錯誤做法：不要在代碼中硬編碼
DATABASE_URL = "postgresql://user:password@host:port/db"
```

#### 2. .env檔案
- 使用 `.env` 檔案管理本地開發環境變數
- 確保 `.env` 已加入 `.gitignore`
- 提供 `.env.example` 作為範例

#### 3. 檔案命名規範
以下檔案類型自動被 `.gitignore` 忽略：
- `setup_remote_*.py`
- `test_*.py`
- `migration_*.py`
- `*_test.py`
- `*_migration.py`
- `secrets.py`
- `credentials.py`
- `config_*.py`
- `deploy_*.py`
- `remote_*.py`
- `production_*.py`

## 🔐 認證與會話安全

### JWT 令牌安全
- **避免使用 localStorage**: JWT 令牌應存儲在 HttpOnly cookies 中，避免 XSS 攻擊
- **令牌過期處理**: 實現自動令牌刷新機制（當前設置為8小時過期）
- **令牌撤銷**: 實現令牌黑名單機制用於登出和安全事件

### 密碼安全
- **移除開發密碼**: 立即移除所有硬編碼密碼（changeme, admin123456）
- **密碼複雜度**: 強制執行密碼複雜度要求（至少8字符，包含大小寫字母、數字、特殊字符）
- **bcrypt 安全**: 確保使用適當的 salt rounds（建議 12 以上）
- **密碼歷史**: 防止用戶重複使用最近的密碼

### WebAuthn/Passkey 安全
- **設備綁定**: 實現設備指紋驗證機制
- **憑證管理**: 定期清理過期或未使用的 WebAuthn 憑證
- **備用認證**: 確保生物辨識失敗時的備用認證方案

### 會話管理
- **會話過期**: 維持4分鐘心跳檢測機制
- **並發會話控制**: 限制護理長帳戶的同時登入數量
- **會話固定攻擊防護**: 登入成功後重新生成會話ID
- **設備追蹤**: 記錄最後登入 IP 和設備信息

## 🛡️ API 安全強化

### 速率限制
- **登入端點**: 每IP每分鐘最多5次嘗試
- **API調用**: 每用戶每分鐘最多100次請求
- **敏感操作**: 密碼重置、用戶管理操作額外限制
- **醫師班表API**: 限制每5分鐘更新頻率

### API 版本管理
- 使用 `/api/v1/` 前綴進行版本控制
- 維護向後兼容性策略
- 廢棄的端點逐步淘汰計劃

### 錯誤處理安全
- 統一錯誤響應格式，避免內部信息洩露
- 記錄所有安全相關錯誤事件
- 對外隱藏 SQLAlchemy 錯誤詳情

### 管理員端點安全
- 管理員操作需要額外的身份驗證步驟
- 敏感操作（用戶管理、資料庫初始化）需要操作確認碼
- 記錄所有管理員操作審計日誌

## 🏥 醫療數據保護

### 數據加密
- **傳輸加密**: 強制使用 HTTPS/TLS 1.3
- **數據庫加密**: 敏感字段（如醫護人員個人信息）進行字段級加密
- **備份加密**: 所有數據庫備份必須加密存儲
- **WebAuthn 密鑰**: 確保生物辨識密鑰安全存儲

### 審計日誌
- **操作記錄**: 記錄所有班表修改、用戶管理、調班申請操作
- **訪問記錄**: 記錄敏感數據的訪問時間和用戶
- **異常行為**: 監控異常登入模式和批量數據訪問
- **加班分配**: 記錄所有自動分配算法執行過程

### 數據保留政策
- **班表數據**: 保留3年後自動歸檔
- **日誌數據**: 安全日誌保留1年，操作日誌保留6個月
- **用戶數據**: 用戶離職後數據匿名化處理
- **調班記錄**: 完整保留所有調班申請歷史

### 隱私保護
- **最小權限原則**: 用戶只能訪問工作必需的數據
- **身份隔離**: 不同身份（麻醉專科護理師、恢復室護理師等）數據隔離
- **數據匿名化**: 統計報告中移除個人識別信息
- **數據導出控制**: 限制批量數據導出功能

## 🏗️ 基礎設施安全

### 容器安全
- **基礎鏡像**: 使用官方精簡版基礎鏡像
- **漏洞掃描**: 定期掃描容器鏡像漏洞
- **運行時安全**: 非root用戶運行應用程序
- **資源限制**: 設置適當的CPU和內存限制

### 安全標頭配置
```javascript
// FastAPI 生產環境必須配置的安全標頭
from fastapi.middleware.cors import CORSMiddleware
from fastapi.middleware.trustedhost import TrustedHostMiddleware

# 安全標頭中間件
app.add_middleware(
    TrustedHostMiddleware,
    allowed_hosts=["*.hospital.org", "localhost"]
)

# CORS 安全配置
app.add_middleware(
    CORSMiddleware,
    allow_origins=origins,  # 來自環境變數
    allow_credentials=True,
    allow_methods=["GET", "POST", "PUT", "DELETE"],
    allow_headers=["*"],
)
```

### 部署安全檢查清單
- [ ] 所有環境變數已正確設置
- [ ] 數據庫連接使用加密連接（SSL/TLS）
- [ ] HTTPS 證書有效且正確配置
- [ ] 防火牆規則僅開放必要端口（3000, 8000）
- [ ] 日誌收集和監控已配置
- [ ] 備份策略已測試並可恢復
- [ ] pnpm 和 uv 安全配置已啟用

### 備份安全
- **加密備份**: 所有備份文件必須加密
- **異地存儲**: 備份存儲在不同地理位置
- **恢復測試**: 每月測試備份恢復流程
- **訪問控制**: 限制備份文件訪問權限

## 📊 安全監控與事件響應

### 安全監控
- **登入監控**: 監控異常登入時間、地點、設備
- **權限濫用**: 監控超出正常職責範圍的操作
- **數據異常**: 監控大量數據訪問或導出行為
- **系統異常**: 監控異常錯誤率和響應時間
- **調班異常**: 監控異常調班模式和批量申請

### 安全事件分類
- **P0 嚴重**: 數據洩露、系統入侵、服務全面中斷
- **P1 高風險**: 權限提升、異常訪問模式、部分服務中斷
- **P2 中風險**: 登入異常、配置錯誤、性能異常
- **P3 低風險**: 一般操作錯誤、輕微配置問題

### 事件響應流程
1. **檢測與報告** (15分鐘內)
   - 自動告警觸發
   - 人工驗證和升級
2. **初步響應** (30分鐘內)
   - 隔離受影響系統
   - 保護證據和日誌
3. **深入調查** (2小時內)
   - 確定攻擊範圍和影響
   - 分析攻擊向量
4. **恢復和總結** (24小時內)
   - 系統恢復和驗證
   - 事後分析和改進措施

### 聯繫方式
- **IT安全團隊**: security@hospital.org
- **系統管理員**: admin@hospital.org
- **護理部主管**: nursing.head@hospital.org
- **資訊安全負責人**: ciso@hospital.org

## 💻 代碼安全最佳實踐

### 安全開發指南
- **輸入驗證**: 所有用戶輸入必須通過 Pydantic schemas 驗證
- **輸出編碼**: 防止 XSS 攻擊，特別是用戶生成的內容
- **SQL 注入防護**: 僅使用 SQLAlchemy ORM，禁止原生 SQL
- **命令注入防護**: 避免直接執行系統命令
- **CSRF 防護**: 對所有狀態變更操作實施 CSRF 保護

### 代碼審查檢查項目
- [ ] 無硬編碼密碼或 API 密鑰
- [ ] 正確的錯誤處理，不洩露敏感信息
- [ ] 適當的權限檢查（role-based access control）
- [ ] 輸入驗證和輸出編碼
- [ ] 日誌記錄不包含敏感數據（密碼、token）
- [ ] WebAuthn 實現遵循最佳實踐

### 第三方依賴安全
- **定期更新**: 每月檢查和更新依賴包
- **漏洞掃描**: 使用 `pnpm audit` 和 `safety` 工具掃描
- **最小化依賴**: 只使用必要的第三方包
- **可信來源**: 僅從官方倉庫安裝包
- **鎖定版本**: 使用 pnpm-lock.yaml 鎖定確切版本

### 測試環境安全
- **隔離環境**: 測試環境與生產環境完全隔離
- **測試數據**: 使用匿名化或合成數據
- **訪問控制**: 限制測試環境訪問權限
- **定期清理**: 定期清理測試數據和環境

## 🚨 敏感資訊洩露應急處理

### 立即行動清單
1. **停止使用洩露的憑證**
2. **更改所有相關密碼**
3. **清理Git歷史**
4. **通知相關人員**

### Git歷史清理方法

#### 方法1：git filter-branch（已執行）
```bash
# 刪除敏感檔案
git filter-branch --force --index-filter 'git rm --cached --ignore-unmatch path/to/sensitive/file' --prune-empty --tag-name-filter cat -- --all

# 替換敏感字串
FILTER_BRANCH_SQUELCH_WARNING=1 git filter-branch --force --tree-filter 'find . -name "*.py" -type f -exec sed -i "" "s/SENSITIVE_STRING/[REDACTED]/g" {} + 2>/dev/null || true' --prune-empty --tag-name-filter cat -- --all

# 強制推送
git push --force origin main
git push --force origin --tags

# 清理本地
rm -rf .git/refs/original/
git reflog expire --expire=now --all
git gc --prune=now --aggressive
```

#### 方法2：BFG Repo-Cleaner（推薦）
```bash
# 安裝 BFG
brew install bfg

# 刪除敏感檔案
bfg --delete-files "sensitive-file.py"

# 替換敏感字串
bfg --replace-text passwords.txt

# 清理和推送
git reflog expire --expire=now --all
git gc --prune=now --aggressive
git push --force origin main
```

## 🛡️ 防護措施

### 1. Pre-commit Hook
建議設置 pre-commit hook 檢查敏感資訊：
```bash
#!/bin/sh
# 檢查是否包含密碼模式
if git diff --cached --name-only | xargs grep -l "password.*=" 2>/dev/null; then
    echo "警告：發現可能的密碼！"
    exit 1
fi
```

### 2. 定期安全檢查
- 每月檢查 `.gitignore` 是否更新
- 定期掃描代碼庫是否有硬編碼的敏感資訊
- 檢查環境變數設置是否正確

### 3. 團隊培訓
- 新成員必須閱讀此安全指南
- 定期進行安全意識培訓
- 建立敏感資訊洩露回報機制

## 📞 安全事件回報

如發現安全問題，請立即聯絡：
- 系統管理員
- 資訊安全負責人
- 專案負責人

## 🔍 安全檢查清單

### 基礎安全
- [ ] 所有敏感配置已改為環境變數
- [ ] `.env` 檔案已加入 `.gitignore`
- [ ] 沒有硬編碼的密碼或API密鑰
- [ ] 測試檔案和部署腳本已排除版本控制
- [ ] Git歷史中無敏感資訊
- [ ] 設置了適當的 `.gitignore` 規則
- [ ] 團隊成員已了解安全規範

### 認證與授權
- [ ] 移除所有硬編碼開發密碼
- [ ] JWT 令牌使用 HttpOnly cookies
- [ ] WebAuthn 憑證管理機制已實施
- [ ] 密碼複雜度要求已強制執行
- [ ] 會話管理和過期策略已配置
- [ ] 多因素認證已啟用（管理員）

### API 安全
- [ ] 速率限制已實施
- [ ] CORS 配置已正確設置
- [ ] 錯誤處理不洩露敏感信息
- [ ] 所有輸入通過 Pydantic 驗證
- [ ] API 版本控制已實施
- [ ] 管理員端點額外安全措施已配置

### 醫療數據保護
- [ ] 數據傳輸使用 HTTPS/TLS
- [ ] 敏感數據庫字段已加密
- [ ] 審計日誌已配置
- [ ] 數據保留政策已實施
- [ ] 隱私保護措施已落實
- [ ] 數據備份已加密

### 基礎設施安全
- [ ] 容器安全配置已優化
- [ ] 安全標頭已配置
- [ ] 防火牆規則已正確設置
- [ ] 監控和告警已配置
- [ ] 備份恢復流程已測試
- [ ] 部署環境已加固

### 監控與響應
- [ ] 安全事件監控已配置
- [ ] 事件響應流程已建立
- [ ] 安全聯繫人清單已更新
- [ ] 定期安全評估已安排
- [ ] 員工安全培訓已完成
- [ ] 入侵檢測系統已部署

---

## 🎯 安全目標與合規

### 醫療資訊安全目標
- **可用性**: 系統 99.9% 正常運行時間
- **完整性**: 數據零篡改容忍度
- **機密性**: 嚴格控制數據訪問權限
- **可追溯性**: 完整的操作審計軌跡

### 合規要求
- **個人資料保護法**: 確保醫護人員個人資料安全
- **醫療資訊安全**: 符合醫院資訊安全政策
- **職業安全**: 保護工作排班敏感信息

### 安全文化
- **零信任原則**: 驗證每個用戶和設備
- **最小權限**: 僅提供工作所需的最小權限
- **深度防禦**: 多層安全控制措施
- **持續改進**: 定期評估和更新安全措施

---

**🛡️ 記住：在醫療環境中，安全不僅是技術要求，更是患者和醫護人員安全的基石！**
**👥 安全是每個人的責任，從開發到部署，從管理到使用！** 