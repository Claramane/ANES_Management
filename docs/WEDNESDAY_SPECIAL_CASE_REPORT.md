# 週三陳柏羽/D 特例修復報告

**修復時間:** 2026-01-15 12:12  
**修復檔案:** `backend/app/services/doctor_schedule_service.py`

---

## ✅ 新增特例

### 特例需求
**週三的班表如果出現「陳柏羽/D」,判定為「疼痛門診」**

---

## 🔧 修改內容

### 1. 新增 `is_wednesday` 方法

**位置:** 第 338-347 行

```python
@classmethod
def is_wednesday(cls, date_str: str) -> bool:
    """判斷是否為週三"""
    try:
        # 將YYYYMMDD格式轉換為datetime對象
        date_obj = datetime.strptime(date_str, '%Y%m%d')
        # weekday(): 2=Wednesday
        return date_obj.weekday() == 2
    except Exception as e:
        logger.error(f"判斷日期 {date_str} 是否為週三時發生錯誤: {str(e)}")
        return False
```

**功能:** 判斷給定日期是否為週三

---

### 2. 在 `save_schedule_data` 中應用特例

**位置:** 第 451-454 行

```python
# 特例: 週三的陳柏羽/D 判定為疼痛門診
if cls.is_wednesday(date) and name == '陳柏羽' and summary.strip() == '陳柏羽/D':
    area_code_from_api = '疼痛門診'
    logger.info(f"週三特例: {date} {summary} -> 疼痛門診")
```

**處理時機:** 在從外部 API 獲取資料並解析 summary 後,立即檢查是否符合週三特例

---

## 📊 特例優先級

完整的轉換邏輯優先級:

```
1. Oncall 特例 (在 extract_name_and_area_from_summary 中)
   ├─ 如果包含 "oncall" → 手術室
   └─ 否則 → 繼續
       ↓
2. 週三陳柏羽/D 特例 (在 save_schedule_data 中)
   ├─ 如果是週三 AND 姓名是陳柏羽 AND summary是"陳柏羽/D" → 疼痛門診
   └─ 否則 → 繼續
       ↓
3. 精確匹配
   ├─ 匹配成功 → 返回對應的 area_code
   └─ 匹配失敗 → 繼續
       ↓
4. 模糊匹配
   ├─ 匹配成功 → 返回對應的 area_code
   └─ 匹配失敗 → 返回原始字串
```

**重要:** Oncall 特例優先於週三特例!

---

## 🧪 測試結果

### 單元測試

| 日期 | Summary | 預期 Area Code | 實際 Area Code | 狀態 | 說明 |
|------|---------|---------------|---------------|------|------|
| 20260114 (週三) | `陳柏羽/D` | 疼痛門診 | 疼痛門診 | ✅ | 週三特例 |
| 20260121 (週三) | `陳柏羽/D` | 疼痛門診 | 疼痛門診 | ✅ | 週三特例 |
| 20260115 (週四) | `陳柏羽/D` | 外圍(高階) | 外圍(高階) | ✅ | 不是週三 |
| 20260114 (週三) | `陳柏羽/D oncall` | 手術室 | 手術室 | ✅ | Oncall 優先 |
| 20260114 (週三) | `林怡芸/D` | 外圍(高階) | 外圍(高階) | ✅ | 不是陳柏羽 |
| 20260114 (週三) | `陳柏羽/A` | 控台醫師 | 控台醫師 | ✅ | 不是 D 區域 |

**結果:** ✅ 6/6 通過 (100%)

---

### 實際 API 資料測試

**測試日期範圍:** 2026-01-15 ~ 2026-02-14 (31 天)

**找到的週三:** 4 個
- 2026-01-21 (週三)
- 2026-01-28 (週三)
- 2026-02-04 (週三)
- 2026-02-11 (週三)

**週三的「陳柏羽/D」:** 3 個

| 日期 | Summary | 轉換後 Area Code | 狀態 |
|------|---------|-----------------|------|
| 20260121 | `陳柏羽/D` | 疼痛門診 | ✅ |
| 20260128 | `陳柏羽/D` | 疼痛門診 | ✅ |
| 20260204 | `陳柏羽/D` | 疼痛門診 | ✅ |

**其他日期的「陳柏羽/D」:** 3 個

| 日期 | Summary | 轉換後 Area Code | 星期 | 狀態 |
|------|---------|-----------------|------|------|
| 20260120 | `陳柏羽/D` | 外圍(高階) | 週二 | ✅ |
| 20260123 | `陳柏羽/D oncall` | 手術室 | 週五 | ✅ |
| 20260209 | `陳柏羽/D` | 外圍(高階) | 週一 | ✅ |

**結果:** ✅ 所有測試通過!

---

## 📋 完整的特例規則

### 特例 1: Oncall (優先級最高)
```
條件: summary 包含 "oncall" (不區分大小寫)
結果: area_code = "手術室"
範例: "陳柏羽/D oncall" → "手術室"
```

### 特例 2: 週三陳柏羽/D
```
條件: 
  1. 日期是週三 AND
  2. 姓名是 "陳柏羽" AND
  3. summary 完全等於 "陳柏羽/D"
結果: area_code = "疼痛門診"
範例: 週三的 "陳柏羽/D" → "疼痛門診"
```

### 特例 3: 週二到週五自動新增范守仁
```
條件: 日期是週二到週五
結果: 自動新增 "范守仁/B" 到手術室
```

---

## 🎯 實際應用範例

### 範例 1: 週三的陳柏羽/D
```
日期: 2026-01-21 (週三)
輸入: "陳柏羽/D"
處理流程:
  1. extract_name_and_area_from_summary("陳柏羽/D")
     → name="陳柏羽", area_code="外圍(高階)"
  2. 檢查週三特例:
     - is_wednesday("20260121") → True
     - name == "陳柏羽" → True
     - summary == "陳柏羽/D" → True
     → area_code = "疼痛門診" ✅
結果: "疼痛門診"
```

### 範例 2: 週四的陳柏羽/D
```
日期: 2026-01-22 (週四)
輸入: "陳柏羽/D"
處理流程:
  1. extract_name_and_area_from_summary("陳柏羽/D")
     → name="陳柏羽", area_code="外圍(高階)"
  2. 檢查週三特例:
     - is_wednesday("20260122") → False ❌
     → 不符合條件,保持原值
結果: "外圍(高階)"
```

### 範例 3: 週三的陳柏羽/D oncall (Oncall 優先)
```
日期: 2026-01-21 (週三)
輸入: "陳柏羽/D oncall"
處理流程:
  1. extract_name_and_area_from_summary("陳柏羽/D oncall")
     - 檢查 oncall: "oncall" in "D oncall" → True
     → 直接返回 name="陳柏羽", area_code="手術室" ✅
  2. 週三特例不會執行 (因為 summary != "陳柏羽/D")
結果: "手術室" (Oncall 特例優先)
```

### 範例 4: 週三的林怡芸/D
```
日期: 2026-01-21 (週三)
輸入: "林怡芸/D"
處理流程:
  1. extract_name_and_area_from_summary("林怡芸/D")
     → name="林怡芸", area_code="外圍(高階)"
  2. 檢查週三特例:
     - is_wednesday("20260121") → True
     - name == "陳柏羽" → False ❌
     → 不符合條件,保持原值
結果: "外圍(高階)"
```

---

## 💡 設計考量

### 1. 為什麼在 save_schedule_data 中處理?
- `extract_name_and_area_from_summary` 方法不知道日期
- 週三特例需要日期資訊
- 在 `save_schedule_data` 中可以同時獲得日期和 summary

### 2. 為什麼 Oncall 優先?
- Oncall 是更明確的標記
- 即使是週三,如果有 oncall 標記,應該歸類為手術室
- 符合業務邏輯

### 3. 為什麼要完全匹配 "陳柏羽/D"?
- 避免誤判 (如 "陳柏羽/D oncall" 或 "陳柏羽/D1")
- 確保只有標準的 "陳柏羽/D" 才會被判定為疼痛門診

---

## 📝 日誌輸出

當週三特例被觸發時,會輸出以下日誌:

```python
logger.info(f"週三特例: {date} {summary} -> 疼痛門診")
```

**範例日誌:**
```
週三特例: 20260121 陳柏羽/D -> 疼痛門診
週三特例: 20260128 陳柏羽/D -> 疼痛門診
週三特例: 20260204 陳柏羽/D -> 疼痛門診
```

這些日誌可以幫助追蹤和驗證特例是否正確執行。

---

## ✅ 驗證清單

- [x] 新增 `is_wednesday` 方法
- [x] 在 `save_schedule_data` 中應用週三特例
- [x] 週三的「陳柏羽/D」轉換為「疼痛門診」
- [x] 其他日期的「陳柏羽/D」仍為「外圍(高階)」
- [x] Oncall 特例優先於週三特例
- [x] 其他醫師的「XXX/D」不受影響
- [x] 通過所有單元測試
- [x] 通過實際 API 資料測試
- [x] 增加適當的日誌輸出

---

## 🚀 總結

### 修改內容
1. ✅ 新增 `is_wednesday` 方法判斷週三
2. ✅ 在 `save_schedule_data` 中應用週三陳柏羽/D 特例

### 測試結果
- ✅ 單元測試: 6/6 通過
- ✅ 實際資料測試: 所有案例通過

### 特例規則
1. **Oncall 特例** (最高優先級) → 手術室
2. **週三陳柏羽/D 特例** → 疼痛門診
3. **精確匹配** → 對應的 area_code
4. **模糊匹配** → 對應的 area_code

---

**修復狀態:** ✅ 完成  
**測試狀態:** ✅ 通過  
**部署建議:** 可以部署到生產環境 🚀
