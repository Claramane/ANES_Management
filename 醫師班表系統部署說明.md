# 醫師班表管理系統部署說明

## 系統概述

本系統實現了一個完整的醫師班表管理方案，包含：

1. **後端定時更新**: 每5分鐘從外部API更新班表資料到資料庫
2. **前端自動刷新**: 每1分鐘自動從後端獲取最新班表
3. **資料庫存儲**: 結構化存儲班表資料，支援區域代碼管理
4. **現代化UI**: 基於今日班表的視覺化顯示

## 系統架構

```
外部API (docdutyapi.zeabur.app)
    ↓ (每5分鐘)
後端定時任務
    ↓
資料庫 (doctor_schedules, day_shift_doctors)
    ↓ (每1分鐘)
前端應用
    ↓
用戶界面
```

## 部署步驟

### 1. 資料庫設置

#### 1.1 安裝新依賴
```bash
cd backend
pip install -r requirements.txt
```

新增的套件：
- `APScheduler==3.10.4` - 定時任務
- `requests==2.31.0` - HTTP請求

#### 1.2 執行資料庫遷移
```bash
cd backend
python migration_add_doctor_schedule.py
```

這將創建以下資料表：
- `doctor_schedules` - 每日班表主表
- `day_shift_doctors` - 白班醫師詳細資料
- `doctor_schedule_update_logs` - 更新日誌

#### 1.3 驗證資料表創建
檢查資料庫中是否成功創建了三個新表。

### 2. 後端部署

#### 2.1 啟動應用
```bash
cd backend
uvicorn main:app --reload --host 0.0.0.0 --port 8000
```

#### 2.2 驗證後端功能
- 檢查定時任務啟動日誌
- 測試API端點: `GET /api/doctor-schedules/health`
- 確認定時任務每5分鐘執行一次

### 3. 前端部署

前端無需額外設置，已自動整合新功能：
- API調用已切換到後端
- 自動1分鐘刷新機制
- 使用後端轉換的區域代碼

### 4. 系統測試

#### 4.1 執行測試腳本
```bash
cd backend
python test_doctor_schedule_system.py
```

#### 4.2 手動測試檢查項目
- [ ] 外部API連接正常
- [ ] 後端健康檢查通過
- [ ] 定時任務正常執行
- [ ] 資料庫正確存儲班表資料
- [ ] 前端正確顯示今日班表
- [ ] 自動刷新功能正常

## 新功能特色

### 1. 資料庫結構

#### 1.1 醫師每日班表 (`doctor_schedules`)
- `date`: 日期 (YYYYMMDD格式)
- `duty_doctor`: 值班醫師
- `schedule_notes`: 排班注記 (JSON格式)

#### 1.2 白班醫師資料 (`day_shift_doctors`)
- `name`: 醫師姓名 (從summary中提取)
- `area_code`: 轉換後的區域代碼 (如: "控台醫師", "刀房")
- `original_summary`: 原始summary
- `time`: 工作時間
- `active`: 啟用狀態

#### 1.3 更新日誌 (`doctor_schedule_update_logs`)
- 記錄每次API更新的結果和統計

### 2. 區域代碼轉換

| 原始代碼 | 轉換後 |
|---------|--------|
| /A | 控台醫師 |
| /B | 刀房 |
| /C | 外圍(3F) |
| /D | 外圍(高階) |
| /E | 刀房 |

### 3. API端點

#### 3.1 班表查詢
- `GET /api/doctor-schedules/schedules/{start_date}/{end_date}`
- 返回指定日期範圍的班表資料

#### 3.2 今日班表
- `GET /api/doctor-schedules/today`
- 返回今日班表摘要

#### 3.3 健康檢查
- `GET /api/doctor-schedules/health`
- 檢查系統和外部API狀態

#### 3.4 管理功能 (僅控台醫師)
- `PUT /api/doctor-schedules/doctor/{doctor_id}/area-code`
- `PUT /api/doctor-schedules/doctor/{doctor_id}/toggle-active`

### 4. 自動化特性

#### 4.1 定時更新 (後端)
- 每5分鐘從外部API獲取當月班表
- 每天凌晨1點更新下月班表
- 自動處理資料轉換和存儲

#### 4.2 自動刷新 (前端)
- 每1分鐘自動向後端請求最新資料
- 無需手動刷新頁面
- 顯示最後更新時間

## 操作說明

### 1. 查看班表
- 進入醫師班表頁面即可看到當月班表
- 頂部顯示今日各工作區域的醫師
- 日曆格式顯示整月班表

### 2. 切換月份
- 使用右上角日期選擇器選擇年月
- 系統自動載入對應月份的班表

### 3. 手動刷新
- 點擊"重新載入"按鈕立即更新
- 查看最後更新時間確認資料新鮮度

### 4. 權限管理
- 控台醫師可更改其他醫師的區域代碼
- 可啟用/停用特定醫師顯示

## 監控和維護

### 1. 日誌監控
- 檢查定時任務執行日誌
- 監控外部API連接狀態
- 查看資料庫更新記錄

### 2. 故障排除

#### 2.1 定時任務不執行
- 檢查APScheduler是否正確啟動
- 確認應用啟動時的任務初始化日誌

#### 2.2 外部API無回應
- 系統會自動記錄失敗日誌
- 下次定時執行時會自動重試

#### 2.3 前端顯示異常
- 檢查後端API是否正常回應
- 確認認證token是否有效

## 效能優化

### 1. 資料庫優化
- 日期欄位已建立索引
- 定期清理過期的更新日誌

### 2. 快取策略
- 前端1分鐘快取避免過頻繁請求
- 後端5分鐘更新平衡即時性和效能

### 3. 錯誤處理
- 完整的異常捕獲和日誌記錄
- 優雅的降級處理機制

## 安全考量

### 1. API認證
- 所有後端API都需要有效認證token
- 控台醫師權限檢查

### 2. 資料驗證
- 輸入資料格式驗證
- SQL注入防護

### 3. 錯誤資訊
- 不暴露敏感系統資訊
- 標準化錯誤回應格式

---

## 問題回報

如遇到問題，請提供：
1. 錯誤發生時間
2. 具體操作步驟
3. 瀏覽器控制台錯誤信息
4. 後端日誌相關記錄

## 更新記錄

- **v1.0** (2025-01-31): 初版實現，包含完整的醫師班表管理功能 