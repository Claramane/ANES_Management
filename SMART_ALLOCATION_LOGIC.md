# æ™ºèƒ½åˆ†é…æ’ç­é‚è¼¯æ¶æ§‹æ–‡æª”

## ğŸ“Š æ ¸å¿ƒæ¦‚å¿µ

### çµ±ä¸€åˆ†æ•¸å°å‘ç®—æ³•
æ™ºèƒ½åˆ†é…æ’ç­ç³»çµ±åŸºæ–¼ã€Œçµ±ä¸€åˆ†æ•¸å°å‘ç®—æ³•ã€ï¼Œç›®æ¨™æ˜¯å¯¦ç¾æœ€ä½³çš„åˆ†æ•¸å¹³è¡¡ï¼Œè®“æ‰€æœ‰è­·ç†å¸«çš„åˆ†æ•¸ç›¡å¯èƒ½æ¥è¿‘é›¶åˆ†ã€‚

## ğŸ¯ åˆ†æ•¸ç³»çµ±

### ç­åˆ¥åˆ†æ•¸é…ç½®
```javascript
const SHIFT_SCORES = {
  A: 2.0,   // Aç­åƒ¹å€¼æœ€é«˜ï¼ˆå°å¤œç­ï¼Œåƒ¹å€¼æ˜¯Bç­çš„2å€ï¼‰
  B: 1.0,   // Bç­åŸºæº–åˆ†æ•¸ï¼ˆå¤§å¤œç­ï¼‰
  C: 0.8,   // Cç­ç•¥ä½æ–¼Bç­
  D: 0.3,   // Dç­ä½åˆ†å€¼ç­åˆ¥
  E: 0.0,   // Eç­é›¶åˆ†
  F: 0.0    // Fç­é›¶åˆ†
};
```

### åŸºç¤åˆ†æ•¸è¨ˆç®—
- **æœªåŠ ç­ç™½ç­æ‰£åˆ†**: -0.365åˆ†ï¼ˆç¶“éæ•¸å­¸è¨ˆç®—çš„å¹³è¡¡å€¼ï¼‰
- **å‡ºå‹¤ç‡æ¨¡æ“¬**: æ ¹æ“šç”¨æˆ¶ID % 4 æ±ºå®šä¸åŒå‡ºå‹¤æ¨¡å¼
  - é¡å‹0: 90% å‡ºå‹¤ç‡ï¼ˆæ­£å¸¸å‡ºå‹¤ï¼‰
  - é¡å‹1: 95% å‡ºå‹¤ç‡ï¼ˆé«˜å‡ºå‹¤ï¼‰
  - é¡å‹2: 70% å‡ºå‹¤ç‡ï¼ˆå¤œç­äººå“¡ï¼‰
  - é¡å‹3: 85% å‡ºå‹¤ç‡ï¼ˆå¶æœ‰è«‹å‡ï¼‰

### åˆ†æ•¸è¨ˆç®—å…¬å¼
```
ç”¨æˆ¶åŸºç¤åˆ†æ•¸ = å¯¦éš›ç™½ç­å¤©æ•¸ Ã— (-0.365)
æœ€çµ‚åˆ†æ•¸ = åŸºç¤åˆ†æ•¸ + æ‰€æœ‰åŠ ç­åˆ†æ•¸ç¸½å’Œ
```

## ğŸ—ï¸ ç³»çµ±æ¶æ§‹

### 1. å¸¸æ•¸ç®¡ç†å±¤ (`constants/overtimeConstants.js`)
```javascript
// åˆ†æ•¸ç³»çµ±
export const SHIFT_SCORES = { A: 2.0, B: 1.0, C: 0.8, D: 0.3, E: 0.0, F: 0.0 };
export const NO_OVERTIME_PENALTY = -0.365;

// ç®—æ³•é…ç½®
export const SHIFT_ALLOCATION_ORDER = ['A', 'B', 'C', 'D', 'E', 'F'];
export const MIN_INTERVAL_DAYS = 7;
export const SCORE_THRESHOLD = 0.3;
```

### 2. æ ¸å¿ƒç®—æ³•å±¤ (`utils/overtimeAllocation.js`)

#### a) æ—¥æœŸå·¥å…·å‡½æ•¸ (`dateUtils`)
- `isSunday()`: åˆ¤æ–·æ˜¯å¦ç‚ºé€±æ—¥
- `isSaturday()`: åˆ¤æ–·æ˜¯å¦ç‚ºé€±å…­
- `isWeekend()`: åˆ¤æ–·æ˜¯å¦ç‚ºé€±æœ«
- `getDaysDifference()`: è¨ˆç®—å…©æ—¥æœŸé–“éš”å¤©æ•¸

#### b) åˆ†æ•¸è¨ˆç®—å·¥å…· (`scoreUtils`)
- `calculateOvertimeScore()`: è¨ˆç®—æŒ‡å®šç­åˆ¥çš„åŠ ç­åˆ†æ•¸
- `calculateUserBaseScore()`: è¨ˆç®—ç”¨æˆ¶åŸºç¤åˆ†æ•¸ï¼ˆç™½ç­è² åˆ†ï¼‰
- `calculateScoreStatistics()`: è¨ˆç®—åˆ†æ•¸çµ±è¨ˆçµæœ

#### c) äººå“¡é¸æ“‡ç®—æ³• (`UserSelector`)
```javascript
class UserSelector {
  static selectBestUserForShift(availableUsers, userScores, shiftType, date, allocations) {
    // 1. æŒ‰ç•¶å‰åˆ†æ•¸æ’åºï¼ˆåˆ†æ•¸è¶Šä½è¶Šå„ªå…ˆï¼‰
    // 2. åœ¨åˆ†æ•¸ç›¸è¿‘çš„äººä¸­é€²è¡Œé€²ä¸€æ­¥ç¯©é¸
    // 3. å°æ–¼é‡è¦ç­åˆ¥ï¼ˆAã€Bï¼‰ï¼Œè€ƒæ…®é–“éš”æ™‚é–“
    // 4. é¸æ“‡æœ€é©åˆçš„å€™é¸äºº
  }
}
```

#### d) çµ±ä¸€åˆ†é…ç®—æ³• (`UnifiedScoreAllocation`)
```javascript
class UnifiedScoreAllocation {
  allocate(overtimeData, options) {
    // 1. åˆå§‹åŒ–ç”¨æˆ¶åˆ†æ•¸
    // 2. åŸ·è¡Œåˆ†é…é‚è¼¯
    // 3. åˆ†æçµæœ
    // 4. è¿”å›åˆ†é…çµæœ
  }
}
```

### 3. çµ„ä»¶å±¤ (`components/OvertimeAllocation/`)

#### a) åˆ†é…æŒ‰éˆ• (`OvertimeAllocationButton.jsx`)
- è§¸ç™¼æ™ºèƒ½åˆ†é…çš„ä¸»è¦å…¥å£
- é¡¯ç¤ºåˆ†é…ç‹€æ…‹å’Œé€²åº¦

#### b) åˆ†é…å°è©±æ¡† (`OvertimeAllocationDialog.jsx`)
- **ç¢ºèªå°è©±æ¡†**: é¸æ“‡åˆ†é…æ¨¡å¼
- **é€²åº¦å°è©±æ¡†**: é¡¯ç¤ºåˆ†é…é€²åº¦å’Œç³»çµ±èªªæ˜

#### c) åˆ†é…Hook (`useOvertimeAllocation.js`)
- å°è£åˆ†é…é‚è¼¯çš„React Hook
- ç®¡ç†å°è©±æ¡†ç‹€æ…‹å’Œåˆ†é…æµç¨‹

### 4. æ¥­å‹™é‚è¼¯å±¤ (`hooks/useOvertimeAllocation.js`)
```javascript
export const useOvertimeAllocation = (logger) => {
  // å°è©±æ¡†ç‹€æ…‹ç®¡ç†
  // åŸ·è¡Œå®Œæ•´åˆ†é…
  // åŸ·è¡Œéƒ¨åˆ†åˆ†é…
  // éŒ¯èª¤è™•ç†å’Œæ—¥èªŒè¨˜éŒ„
}
```

## ğŸ”„ åˆ†é…æµç¨‹

### å…©ç¨®åˆ†é…æ¨¡å¼

#### 1. å…¨éƒ¨é‡æ–°æ™ºèƒ½åˆ†é…
```
æ¸…ç©ºç¾æœ‰åˆ†é… â†’ åˆå§‹åŒ–æ‰€æœ‰ç”¨æˆ¶åˆ†æ•¸ â†’ æŒ‰å„ªå…ˆç´šåˆ†é…æ‰€æœ‰ç­åˆ¥ â†’ è¿”å›å®Œæ•´çµæœ
```

#### 2. æ™ºèƒ½è£œé½Šæœªåˆ†é…ç­åˆ¥
```
ä¿ç•™ç¾æœ‰åˆ†é… â†’ è¨ˆç®—ç•¶å‰åˆ†æ•¸ç‹€æ…‹ â†’ åªåˆ†é…ç¼ºå°‘çš„ç­åˆ¥ â†’ è¿”å›æ›´æ–°çµæœ
```

### åˆ†é…ç®—æ³•è©³ç´°æ­¥é©Ÿ

#### éšæ®µ1: å¹³æ—¥åˆ†é…ï¼ˆé€±ä¸€è‡³é€±äº”ï¼‰
```
1. éæ­·æ‰€æœ‰å¹³æ—¥
2. å°æ¯ä¸€å¤©æŒ‰ç­åˆ¥å„ªå…ˆç´šé †åº [A, B, C, D, E, F] åˆ†é…
3. ç‚ºæ¯å€‹ç­åˆ¥é¸æ“‡æœ€é©åˆçš„è­·ç†å¸«ï¼š
   - æ’é™¤éº»é†‰ç§‘Leaderï¼ˆåªèƒ½åˆ†é…Eæˆ–Fç­ï¼‰
   - æŒ‰ç•¶å‰åˆ†æ•¸æ’åºï¼ˆåˆ†æ•¸è¶Šä½è¶Šå„ªå…ˆï¼‰
   - åœ¨åˆ†æ•¸ç›¸è¿‘å€™é¸äººä¸­è€ƒæ…®å…¶ä»–å› ç´ 
   - å°Aã€Bç­è€ƒæ…®é–“éš”æ™‚é–“ï¼ˆé¿å…é€£çºŒåˆ†é…ï¼‰
4. æ›´æ–°é¸ä¸­è­·ç†å¸«çš„åˆ†æ•¸å’Œåˆ†é…è¨˜éŒ„
```

#### éšæ®µ2: é€±å…­åˆ†é…ï¼ˆåƒ…Aç­ï¼‰
```
1. éæ­·æ‰€æœ‰é€±å…­
2. ç‚ºæ¯å€‹é€±å…­åˆ†é…ä¸€ä½Aç­è­·ç†å¸«
3. ä½¿ç”¨ç›¸åŒçš„é¸æ“‡é‚è¼¯ï¼Œä½†åªåˆ†é…Aç­
4. æ›´æ–°åˆ†æ•¸å’Œè¨˜éŒ„
```

### äººå“¡é¸æ“‡é‚è¼¯
```javascript
selectBestUserForShift(availableUsers, userScores, shiftType, date, allocations) {
  // 1. åˆ†æ•¸æ’åºï¼šé¸æ“‡ç•¶å‰åˆ†æ•¸æœ€ä½çš„è­·ç†å¸«
  candidates = availableUsers.sort((a, b) => userScores[a.id] - userScores[b.id])
  
  // 2. åˆ†æ•¸ç›¸è¿‘ç¯©é¸ï¼šåœ¨èª¤å·®ç¯„åœå…§çš„å€™é¸äºº
  closeScoreCandidates = candidates.filter(score <= lowestScore + 0.3)
  
  // 3. é–“éš”æª¢æŸ¥ï¼šå°é‡è¦ç­åˆ¥ï¼ˆAã€Bï¼‰è€ƒæ…®æœ€å°é–“éš”å¤©æ•¸
  if (shiftType === 'A' || shiftType === 'B') {
    return selectWithIntervalCheck(closeScoreCandidates, minInterval: 7å¤©)
  }
  
  // 4. è¿”å›åˆ†æ•¸æœ€ä½çš„å€™é¸äºº
  return candidates[0]
}
```

## ğŸ“ˆ åˆ†æ•¸å¹³è¡¡æ©Ÿåˆ¶

### ç›®æ¨™
è®“æ‰€æœ‰è­·ç†å¸«çš„åˆ†æ•¸ç›¡å¯èƒ½æ¥è¿‘é›¶åˆ†ï¼Œå¯¦ç¾æœ€å¤§åŒ–çš„å…¬å¹³æ€§ã€‚

### å¹³è¡¡ç­–ç•¥
1. **åˆ†æ•¸æœ€ä½å„ªå…ˆ**: ç¸½æ˜¯é¸æ“‡ç•¶å‰åˆ†æ•¸æœ€ä½çš„è­·ç†å¸«
2. **è² åˆ†è£œå„Ÿ**: æœªåŠ ç­çš„ç™½ç­æ‰£è² åˆ†ï¼Œå¹³è¡¡åŠ ç­å¾—åˆ†
3. **é–“éš”æ§åˆ¶**: é‡è¦ç­åˆ¥é¿å…çŸ­æœŸå…§é‡è¤‡åˆ†é…çµ¦åŒä¸€äºº
4. **é›¶åˆ†æ¥è¿‘**: ç®—æ³•ç›®æ¨™æ˜¯è®“åˆ†æ•¸åˆ†ä½ˆçš„å¹³å‡åé›¢é›¶åˆ†æœ€å°

### æ•¸å­¸å¹³è¡¡
```
ç†è«–å¹³å‡åˆ†æ•¸ â‰ˆ 0
NO_OVERTIME_PENALTY = -0.365 ï¼ˆç¶“éè¨ˆç®—çš„å¹³è¡¡å€¼ï¼‰
ç¸½é«”åˆ†æ•¸è¶¨å‹¢ï¼šå‘é›¶åˆ†æ”¶æ–‚
```

## ğŸ› ï¸ æŠ€è¡“ç‰¹è‰²

### 1. æ¨¡çµ„åŒ–è¨­è¨ˆ
- æ¯å€‹åŠŸèƒ½æ¨¡çµ„ç¨ç«‹ï¼Œä¾¿æ–¼æ¸¬è©¦å’Œç¶­è­·
- æ¸…æ™°çš„è·è²¬åˆ†é›¢

### 2. å¯é…ç½®æ€§
- æ‰€æœ‰é‡è¦åƒæ•¸åœ¨å¸¸æ•¸æ–‡ä»¶ä¸­çµ±ä¸€ç®¡ç†
- æ”¯æ´ä¸åŒåƒæ•¸èª¿æ•´å’Œå„ªåŒ–

### 3. å®Œæ•´æ—¥èªŒ
- è©³ç´°çš„åˆ†é…éç¨‹æ—¥èªŒ
- ä¾¿æ–¼èª¿è©¦å’Œè¿½è¹¤å•é¡Œ

### 4. éŒ¯èª¤è™•ç†
- å®Œå–„çš„ç•°å¸¸æ•ç²å’Œè™•ç†
- ç”¨æˆ¶å‹å¥½çš„éŒ¯èª¤æç¤º

### 5. æ•ˆèƒ½å„ªåŒ–
- éé˜»å¡ç®—æ³•åŸ·è¡Œ
- é€²åº¦åé¥‹å’Œå–æ¶ˆæ©Ÿåˆ¶

## ğŸ”§ ä½¿ç”¨æ–¹å¼

### å‰ç«¯èª¿ç”¨
```javascript
// 1. è§¸ç™¼æ™ºèƒ½åˆ†é…
const allocationHook = useOvertimeAllocation(logger);
allocationHook.showAllocationDialog();

// 2. åŸ·è¡Œå®Œæ•´åˆ†é…
const result = await allocationHook.performFullAllocation(overtimeData);

// 3. åŸ·è¡Œéƒ¨åˆ†åˆ†é…
const result = await allocationHook.performPartialAllocation(overtimeData, existingMarkings);
```

### æ ¸å¿ƒç®—æ³•èª¿ç”¨
```javascript
// ç›´æ¥ä½¿ç”¨æ ¸å¿ƒç®—æ³•
import { createAllocator } from '../utils/overtimeAllocation';

const allocator = createAllocator(logger);
const result = allocator.allocate(overtimeData, options);
```

## ğŸ“Š çµæœåˆ†æ

### åˆ†é…çµæœåŒ…å«
1. **æ–°åˆ†é…æ¨™è¨˜**: `{ dateKey: { userId: shift } }`
2. **åˆ†æ•¸çµ±è¨ˆ**: æœ€å°å€¼ã€æœ€å¤§å€¼ã€å¹³å‡å€¼ã€åé›¢åº¦
3. **åˆ†é…æ—¥èªŒ**: è©³ç´°çš„åˆ†é…éç¨‹è¨˜éŒ„

### è©•ä¼°æŒ‡æ¨™
- **åˆ†æ•¸ç¯„åœ**: æœ€é«˜åˆ†èˆ‡æœ€ä½åˆ†çš„å·®è·
- **å¹³å‡åé›¢é›¶åˆ†**: æ‰€æœ‰åˆ†æ•¸çµ•å°å€¼çš„å¹³å‡
- **åˆ†é…æˆåŠŸç‡**: æˆåŠŸåˆ†é…çš„ç­åˆ¥æ¯”ä¾‹
- **å¹³è¡¡åº¦**: åˆ†æ•¸åˆ†ä½ˆçš„å‡å‹»ç¨‹åº¦

## ğŸ¯ ç®—æ³•å„ªå‹¢

1. **å…¬å¹³æ€§**: ç¢ºä¿åŠ ç­åˆ†é…çš„å…¬å¹³æ€§
2. **å¹³è¡¡æ€§**: ç¶­æŒè­·ç†å¸«é–“çš„åˆ†æ•¸å¹³è¡¡
3. **æ™ºèƒ½æ€§**: è€ƒæ…®å¤šç¨®å› ç´ çš„æ™ºèƒ½é¸æ“‡
4. **éˆæ´»æ€§**: æ”¯æ´å¤šç¨®åˆ†é…æ¨¡å¼
5. **å¯ç¶­è­·æ€§**: æ¨¡çµ„åŒ–è¨­è¨ˆï¼Œä¾¿æ–¼æ“´å±•å’Œç¶­è­·

---

*æ­¤æ–‡æª”èªªæ˜äº†æ™ºèƒ½åˆ†é…æ’ç­ç³»çµ±çš„å®Œæ•´é‚è¼¯æ¶æ§‹ï¼Œç‚ºç³»çµ±ç¶­è­·å’ŒåŠŸèƒ½æ“´å±•æä¾›åƒè€ƒã€‚*