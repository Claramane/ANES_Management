# æ¶æ§‹è¨­è¨ˆæ–‡ä»¶

## ğŸ—ï¸ ç³»çµ±æ¶æ§‹

### æ•´é«”æ¶æ§‹åœ–

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Zeabur æ­£å¼ç’°å¢ƒ                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  PostgreSQL Database (æ­£å¼è³‡æ–™åº«)         â”‚   â”‚
â”‚  â”‚  - çœŸå¯¦æ¥­å‹™è³‡æ–™                           â”‚   â”‚
â”‚  â”‚  - æŒçºŒæ›´æ–°ä¸­                             â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
                  â”‚ (è®€å–)
                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        Zeabur - DB Sync Service (ç¨ç«‹å°ˆæ¡ˆ)       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  Python åŒæ­¥æœå‹™                          â”‚   â”‚
â”‚  â”‚  - å®šæœŸåŸ·è¡Œ (æ¯10åˆ†é˜)                    â”‚   â”‚
â”‚  â”‚  - å¢é‡åŒæ­¥é‚è¼¯                           â”‚   â”‚
â”‚  â”‚  - å¤šç›®æ¨™æ”¯æ´                             â”‚   â”‚
â”‚  â”‚  - ç’°å¢ƒè®Šæ•¸é…ç½®                           â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
                  â”‚ (å¯«å…¥)
                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚               åŒæ­¥ç›®æ¨™ç’°å¢ƒ                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  æœ¬åœ°é–‹ç™¼ç’°å¢ƒ  â”‚        â”‚  æ¸¬è©¦ç«™ç’°å¢ƒ        â”‚  â”‚
â”‚  â”‚  PostgreSQL   â”‚        â”‚  PostgreSQL       â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### é—œéµè¨­è¨ˆåŸå‰‡

1. **å–®å‘åŒæ­¥**
   - âœ… æ­£å¼ç’°å¢ƒ â†’ æ¸¬è©¦/æœ¬åœ°ç’°å¢ƒï¼ˆå…è¨±ï¼‰
   - âŒ æ¸¬è©¦/æœ¬åœ°ç’°å¢ƒ â†’ æ­£å¼ç’°å¢ƒï¼ˆç¦æ­¢ï¼‰
   - ğŸ”’ åªè®€å–æ­£å¼ç’°å¢ƒï¼Œåªå¯«å…¥ç›®æ¨™ç’°å¢ƒ

2. **å®Œå…¨è§£è€¦**
   - ç¨ç«‹æœå‹™ï¼Œä¸ä¾è³´ä¸»å¾Œç«¯ API
   - ç¨ç«‹éƒ¨ç½²ï¼Œç¨ç«‹è³‡æº
   - ç¨ç«‹æ—¥èªŒå’Œç›£æ§

3. **ç’°å¢ƒè®Šæ•¸é©…å‹•**
   - æ‰€æœ‰é€£ç·šé€šéç’°å¢ƒè®Šæ•¸
   - æ”¯æ´å¤šç›®æ¨™å‹•æ…‹é…ç½®
   - éˆæ´»çš„åŒæ­¥åƒæ•¸è¨­å®š

## ğŸ“Š è³‡æ–™æµå‘

### åŒæ­¥æµç¨‹

```
1. å®šæ™‚è§¸ç™¼ (æ¯10åˆ†é˜)
   â†“
2. è¼‰å…¥ç’°å¢ƒè®Šæ•¸é…ç½®
   â†“
3. é€£æ¥æ­£å¼ç’°å¢ƒè³‡æ–™åº« (SOURCE)
   â†“
4. è®€å–ä¸Šæ¬¡åŒæ­¥æ™‚é–“ (from sync_state)
   â†“
5. æŸ¥è©¢å¢é‡è³‡æ–™ (WHERE updated_at > last_sync_time)
   â†“
6. ä¾ç…§å¤–éµé †åºè™•ç†è¡¨æ ¼
   â†“
7. å°æ¯å€‹ç›®æ¨™ç’°å¢ƒåŸ·è¡Œ UPSERT
   - Target 1: æœ¬åœ°ç’°å¢ƒ (å¦‚æœå•Ÿç”¨)
   - Target 2: æ¸¬è©¦ç«™ (å¦‚æœå•Ÿç”¨)
   â†“
8. æ›´æ–°åŒæ­¥ç‹€æ…‹è¨˜éŒ„
   â†“
9. è¨˜éŒ„æ—¥èªŒå’Œçµ±è¨ˆ
   â†“
10. ç­‰å¾…ä¸‹æ¬¡è§¸ç™¼
```

### è¡¨æ ¼åŒæ­¥é †åº

ä¾ç…§å¤–éµä¾è³´é—œä¿‚ï¼š

```
1. users                      # åŸºç¤è¡¨æ ¼ï¼ˆç„¡ä¾è³´ï¼‰
2. formula_schedules          # ä¾è³´ users
3. monthly_schedules          # ä¾è³´ users
4. schedule_versions          # ä¾è³´ users
5. schedule_version_diffs     # ä¾è³´ schedule_versions
6. schedule_changes           # ä¾è³´ schedule_versions
7. shift_swap_requests        # ä¾è³´ users, schedules
8. overtime_records           # ä¾è³´ users, schedules
9. overtime_points            # ä¾è³´ users
10. overtime_monthly_scores   # ä¾è³´ users
11. overtime_summaries        # ä¾è³´ users
12. announcements             # ä¾è³´ users
13. doctor_schedules          # ç¨ç«‹è¡¨æ ¼
14. day_shift_doctors         # ä¾è³´ doctor_schedules
15. doctor_schedule_update_logs # ä¾è³´ doctor_schedules
16. webauthn_credentials      # ä¾è³´ users
17. logs                      # æœ€å¾Œï¼ˆç„¡ä¾è³´ï¼‰
```

## ğŸ” ç’°å¢ƒè®Šæ•¸è¨­è¨ˆ

### å¿…è¦ç’°å¢ƒè®Šæ•¸

```bash
# ä¾†æºè³‡æ–™åº«ï¼ˆæ­£å¼ç’°å¢ƒï¼‰- å¿…é ˆ
SOURCE_DB_URL=postgresql://user:pass@host:port/database

# ç›®æ¨™è³‡æ–™åº« - è‡³å°‘ä¸€å€‹
TARGET_LOCAL_URL=postgresql://user:pass@localhost:5432/database
TARGET_TEST_URL=postgresql://user:pass@test-host:5432/database

# åŒæ­¥è¨­å®š - å¿…é ˆ
SYNC_TARGETS=local,test          # è¦å•Ÿç”¨çš„ç›®æ¨™ï¼ˆé€—è™Ÿåˆ†éš”ï¼‰
SYNC_INTERVAL_MINUTES=10         # åŒæ­¥é–“éš”ï¼ˆåˆ†é˜ï¼‰
```

### é€²éšç’°å¢ƒè®Šæ•¸

```bash
# åŒæ­¥ç¯„åœæ§åˆ¶
SYNC_TABLES=users,schedules,...  # æŒ‡å®šè¡¨æ ¼ï¼ˆé è¨­ï¼šå…¨éƒ¨ï¼‰
EXCLUDE_FIELDS=users:password,webauthn_credentials:credential_id  # æ’é™¤æ¬„ä½

# æœå‹™è¨­å®š
LOG_LEVEL=INFO                   # æ—¥èªŒç´šåˆ¥: DEBUG, INFO, WARNING, ERROR
ENABLE_HEALTH_CHECK=true         # å•Ÿç”¨å¥åº·æª¢æŸ¥ HTTP ç«¯é»
HEALTH_CHECK_PORT=8080           # å¥åº·æª¢æŸ¥ç«¯å£

# éŒ¯èª¤è™•ç†
MAX_RETRY_ATTEMPTS=3             # æœ€å¤§é‡è©¦æ¬¡æ•¸
RETRY_DELAY_SECONDS=60           # é‡è©¦å»¶é²ï¼ˆç§’ï¼‰

# æ•ˆèƒ½èª¿æ•´
BATCH_SIZE=1000                  # æ‰¹æ¬¡å¤§å°
```

### ç’°å¢ƒè®Šæ•¸é©—è­‰

æœå‹™å•Ÿå‹•æ™‚æœƒé©—è­‰ï¼š
- âœ… SOURCE_DB_URL å¿…é ˆå­˜åœ¨
- âœ… è‡³å°‘ä¸€å€‹ TARGET_*_URL å¿…é ˆå­˜åœ¨
- âœ… SYNC_TARGETS ä¸­æŒ‡å®šçš„ç›®æ¨™å¿…é ˆæœ‰å°æ‡‰çš„ URL
- âœ… æ‰€æœ‰è³‡æ–™åº«é€£ç·šå¯ç”¨æ€§æ¸¬è©¦

## ğŸ”’ å®‰å…¨æ©Ÿåˆ¶

### 1. å–®å‘ä¿è­·

```python
# é˜²æ­¢åå‘åŒæ­¥
if target_url == source_url:
    raise ValueError("ç›®æ¨™ä¸èƒ½èˆ‡ä¾†æºç›¸åŒï¼")

# é˜²æ­¢æ­£å¼ç’°å¢ƒå¯«å…¥
if is_production_url(target_url):
    raise ValueError("ä¸å…è¨±å¯«å…¥æ­£å¼ç’°å¢ƒï¼")
```

### 2. æ•æ„Ÿè³‡æ–™è™•ç†

**æ’é™¤æ¬„ä½**ï¼š
- `users.password` - å¯†ç¢¼
- `webauthn_credentials.credential_id` - ç”Ÿç‰©è¾¨è­˜æ†‘è­‰
- `webauthn_credentials.public_key` - å…¬é‘°

**å¯¦ä½œæ–¹å¼**ï¼š
```python
SENSITIVE_FIELDS = {
    'users': ['password'],
    'webauthn_credentials': ['credential_id', 'public_key']
}
```

### 3. é€£ç·šå®‰å…¨

- ä½¿ç”¨ç’°å¢ƒè®Šæ•¸å„²å­˜æ•æ„Ÿè³‡è¨Š
- ä¸åœ¨ä»£ç¢¼ä¸­ç¡¬ç·¨ç¢¼å¯†ç¢¼
- æ”¯æ´ SSL é€£ç·šï¼ˆsslmode=requireï¼‰

### 4. éŒ¯èª¤éš”é›¢

- å–®ä¸€è¡¨æ ¼å¤±æ•—ä¸å½±éŸ¿å…¶ä»–è¡¨æ ¼
- å®Œæ•´éŒ¯èª¤æ—¥èªŒè¨˜éŒ„
- è‡ªå‹•é‡è©¦æ©Ÿåˆ¶

## ğŸ“ˆ æ•ˆèƒ½è€ƒé‡

### è³‡æºä½¿ç”¨

**é ä¼°è³‡æºéœ€æ±‚**ï¼š
- CPU: 0.5 æ ¸å¿ƒï¼ˆåŒæ­¥æ™‚ï¼‰
- Memory: 256 MB - 512 MB
- ç¶²è·¯: ä¾è³‡æ–™é‡ï¼Œé€šå¸¸ < 50 MB/æ¬¡

**Zeabur å»ºè­°é…ç½®**ï¼š
- Plan: Starter æˆ– Developer
- Auto-scaling: é—œé–‰ï¼ˆå–®ä¸€å¯¦ä¾‹å³å¯ï¼‰

### å„ªåŒ–ç­–ç•¥

1. **å¢é‡åŒæ­¥**
   - åªåŒæ­¥æœ‰ `updated_at` è®Šæ›´çš„è¨˜éŒ„
   - å¤§å¹…æ¸›å°‘è³‡æ–™å‚³è¼¸é‡

2. **æ‰¹æ¬¡è™•ç†**
   - BATCH_SIZE=1000ï¼ˆå¯èª¿æ•´ï¼‰
   - é¿å…ä¸€æ¬¡è¼‰å…¥éå¤šè³‡æ–™

3. **é€£ç·šæ± **
   - é‡ç”¨è³‡æ–™åº«é€£ç·š
   - æ¸›å°‘é€£ç·šé–‹éŠ·

4. **è¡¨æ ¼ç„¡æ™‚é–“æˆ³è™•ç†**
   - è‡ªå‹•æª¢æ¸¬ç„¡ `updated_at` çš„è¡¨æ ¼
   - åŸ·è¡Œå…¨é‡åŒæ­¥ï¼ˆä½†é »ç‡è¼ƒä½ï¼‰

## ğŸ” ç›£æ§èˆ‡æ—¥èªŒ

### æ—¥èªŒæ ¼å¼

```
[2025-10-03 14:30:00] INFO - é–‹å§‹åŸ·è¡Œè³‡æ–™åº«åŒæ­¥
[2025-10-03 14:30:01] INFO - åŒæ­¥è¡¨æ ¼: users (å¢é‡: 5 ç­†)
[2025-10-03 14:30:02] INFO - åŒæ­¥è¡¨æ ¼: schedules (å¢é‡: 120 ç­†)
[2025-10-03 14:30:05] INFO - åŒæ­¥å®Œæˆ: ç¸½å…± 250 ç­†è¨˜éŒ„ï¼Œè€—æ™‚ 5.2 ç§’
```

### å¥åº·æª¢æŸ¥ç«¯é»ï¼ˆå¯é¸ï¼‰

```
GET /health
Response:
{
  "status": "healthy",
  "last_sync_time": "2025-10-03T14:30:05",
  "sync_count": 250,
  "targets": ["local", "test"]
}
```

### åŒæ­¥ç‹€æ…‹è¿½è¹¤

**ç‹€æ…‹æ–‡ä»¶** (`sync_state.json`):
```json
{
  "users": {
    "last_sync_time": "2025-10-03T14:30:01",
    "records_synced": 5,
    "last_error": null
  }
}
```

## ğŸ¯ èˆ‡ç¾æœ‰ç³»çµ±çš„é—œä¿‚

### èˆ‡ä¸»å°ˆæ¡ˆçš„å·®ç•°

| ç‰¹æ€§ | ä¸»å°ˆæ¡ˆ (backend) | DB Sync Service |
|------|-----------------|-----------------|
| **è·è²¬** | æ¥­å‹™é‚è¼¯å’Œ API | è³‡æ–™åŒæ­¥ |
| **éƒ¨ç½²** | Zeabur ä¸»å°ˆæ¡ˆ | Zeabur ç¨ç«‹å°ˆæ¡ˆ |
| **è³‡æº** | API æœå‹™è³‡æº | ç¨ç«‹è³‡æº |
| **ä¾è³´** | å®Œæ•´ä¾è³´æ¨¹ | æœ€å°ä¾è³´ |
| **åŸ·è¡Œæ¨¡å¼** | HTTP è«‹æ±‚é©…å‹• | å®šæ™‚ä»»å‹™é©…å‹• |

### è¤‡ç”¨é‚è¼¯

å¾ä¸»å°ˆæ¡ˆè¤‡ç”¨ï¼š
- âœ… åŒæ­¥é‚è¼¯æ ¸å¿ƒï¼ˆ`sync_db_incremental.py`ï¼‰
- âœ… è¡¨æ ¼é †åºé…ç½®
- âœ… æ•æ„Ÿæ¬„ä½æ¸…å–®

ç¨ç«‹å¯¦ä½œï¼š
- âœ… ç’°å¢ƒè®Šæ•¸é…ç½®ç³»çµ±
- âœ… å¤šç›®æ¨™æ”¯æ´é‚è¼¯
- âœ… æœå‹™å…¥å£å’Œæ’ç¨‹

---

**æ–‡ä»¶ç‰ˆæœ¬**: v1.0
**æœ€å¾Œæ›´æ–°**: 2025-10-03
