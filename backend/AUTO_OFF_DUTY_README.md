# 醫師自動下班與開會自動恢復檢測功能

## 功能概述

本系統提供完整的醫師狀態自動管理功能，包括：

1. **自動下班檢測**：當醫師的工作時段結束時，系統會自動將醫師狀態從「上班」改為「已下班」
2. **開會期間自動下班**：開會期間醫師狀態自動設為「已下班」
3. **開會結束自動恢復**：開會結束後在工作時間內自動恢復「上班」狀態
4. **過期開會行程自動清理**：開會結束後自動刪除過期的開會行程

## 功能特點

- ✅ **全自動運行**：每5分鐘自動檢測，無需人工介入
- ✅ **跨午夜支援**：支援夜班時間（如22:00-06:00）
- ✅ **智能恢復**：開會結束後根據工作時間自動恢復狀態
- ✅ **安全設計**：只處理特定狀態轉換，避免誤操作
- ✅ **完整日誌**：詳細記錄所有狀態變更和行程清理
- ✅ **手動觸發**：提供API端點供管理員手動執行檢測

## 檢測邏輯詳細說明

### 1. 工作時間檢測

系統會檢查每位醫師的工作時間設定（如 `08:00-18:00`），支援：
- **正常班次**：如 `08:00-18:00`、`09:00-17:00`
- **跨午夜夜班**：如 `22:00-06:00`、`00:00-08:00`

### 2. 自動下班檢測

**觸發條件**：
- 醫師狀態為「上班」(`on_duty`)
- 當前時間已超過工作結束時間

**執行動作**：
- 將醫師狀態改為「已下班」(`off_duty`)
- 記錄狀態變更時間
- 產生詳細日誌

### 3. 開會期間自動下班

**觸發條件**：
- 醫師設有開會時間且當前在開會時間內
- 醫師狀態為「上班」(`on_duty`)

**執行動作**：
- 將醫師狀態改為「已下班」(`off_duty`)
- 記錄狀態變更時間
- 產生開會相關日誌

### 4. 開會結束自動恢復（新功能）

#### 4.1 工作時間內恢復上班

**觸發條件**：
- 開會時間已結束（當前時間超過開會結束時間）
- 當前時間在醫師工作時間內
- 醫師狀態為「已下班」(`off_duty`)
- 醫師不是請假狀態（`status != 'off'`）

**執行動作**：
- 將醫師狀態恢復為「上班」(`on_duty`)
- 刪除過期的開會行程設定
- 記錄狀態恢復和行程清理日誌

#### 4.2 下班時間後只清理行程

**觸發條件**：
- 開會時間已結束
- 當前時間已超過醫師工作結束時間

**執行動作**：
- 刪除過期的開會行程設定
- 保持醫師「已下班」狀態
- 記錄行程清理日誌

### 5. 狀態保護機制

- **請假狀態保護**：請假中的醫師不會被自動恢復上班狀態
- **狀態轉換限制**：只處理特定的狀態轉換，避免意外修改
- **時間驗證**：嚴格檢查時間範圍，確保邏輯正確

## 技術實現

### 核心方法

#### `update_doctors_active_status_by_time(db: Session)`
主要的自動檢測方法，負責：
- 獲取今日班表資料
- 逐一檢查每位醫師的狀態
- 執行相應的狀態更新邏輯
- 提交資料庫變更

#### `_is_in_work_time(current_time, start_time, end_time) -> bool`
檢查當前時間是否在工作時間內：
- 支援正常時間範圍（如 08:00-18:00）
- 支援跨午夜時間範圍（如 22:00-06:00）

#### `_is_past_work_time(current_time, end_time) -> bool`
檢查是否已過下班時間：
- 處理跨午夜的特殊情況
- 確保時間比較的準確性

### 定時任務

在 `doctor_schedule_tasks.py` 中設定：
```python
@repeat(every(5).minutes)
async def check_doctors_auto_off_duty():
    """每5分鐘檢查醫師自動下班狀態"""
```

- **執行頻率**：每5分鐘
- **啟動延遲**：系統啟動後10秒
- **錯誤處理**：包含完整的異常處理機制

### API端點

```
POST /api/doctor-schedules/check-auto-off-duty
```

**權限要求**：護理長或管理員
**功能**：手動觸發自動狀態檢測

## 使用方式

### 自動執行（推薦）

系統啟動後會自動開始定時檢測，無需額外設定。

### 手動觸發

使用API端點手動執行檢測：
```bash
curl -X POST "http://localhost:8000/api/doctor-schedules/check-auto-off-duty" \
     -H "Authorization: Bearer YOUR_TOKEN"
```

## 日誌記錄範例

### 自動下班日誌
```
INFO: 醫師 王醫師 已自動設為下班狀態（工作時間: 08:00-18:00，當前時間: 18:05:00）
```

### 開會期間自動下班日誌
```
INFO: 醫師 李醫師 已自動設為下班狀態（開會中: 14:00-15:00）
```

### 開會結束自動恢復日誌
```
INFO: 醫師 張醫師 開會結束，已自動恢復上班狀態（開會時間: 14:00-15:00）
INFO: 醫師 張醫師 的過期開會行程已自動刪除（原開會時間: 14:00-15:00）
```

### 過期行程清理日誌
```
INFO: 醫師 陳醫師 的過期開會行程已自動刪除（已過下班時間，原開會時間: 17:00-18:30）
```

### 檢測完成日誌
```
INFO: 自動狀態更新完成，已更新 3 位醫師的狀態，清除 2 個過期開會行程
```

## 注意事項

### 系統行為
1. **單向下班檢測**：系統只會自動將「上班」改為「已下班」，不會自動恢復上班（除了開會結束的情況）
2. **開會自動恢復**：只在開會結束且仍在工作時間內時自動恢復上班狀態
3. **請假狀態保護**：請假中的醫師不會被自動恢復上班狀態
4. **過期行程清理**：開會結束後會自動刪除過期的開會行程設定

### 時間處理
1. **夜班支援**：系統能正確處理跨午夜的夜班時間
2. **時區一致**：確保系統時間與實際工作時間在同一時區
3. **精確檢測**：使用分鐘級別的時間比較，確保檢測準確性

### 資料安全
1. **資料庫事務**：所有狀態更新都在事務中執行，確保資料一致性
2. **錯誤回滾**：發生錯誤時自動回滾資料庫變更
3. **日誌追蹤**：完整記錄所有狀態變更，便於追蹤和審計

## 故障排除

### 常見問題

#### 1. 醫師狀態沒有自動更新
**可能原因**：
- 工作時間格式不正確（應為 `HH:MM-HH:MM` 格式）
- 醫師狀態已經是「已下班」
- 定時任務沒有運行

**解決方案**：
- 檢查醫師工作時間設定格式
- 查看系統日誌確認定時任務是否正常運行
- 手動觸發API端點進行測試

#### 2. 開會結束後沒有自動恢復上班
**可能原因**：
- 已經過了工作結束時間
- 醫師處於請假狀態
- 開會時間格式不正確

**解決方案**：
- 確認當前時間是否在工作時間內
- 檢查醫師是否為請假狀態
- 驗證開會時間格式是否正確

#### 3. 日誌中出現錯誤訊息
**可能原因**：
- 資料庫連接問題
- 時間格式解析錯誤
- 資料不一致

**解決方案**：
- 檢查資料庫連接狀態
- 驗證時間格式是否符合 `HH:MM-HH:MM` 格式
- 檢查醫師資料完整性

### 調試方法

1. **檢查系統日誌**：查看自動檢測的執行記錄
2. **手動觸發**：使用API端點手動執行檢測
3. **資料驗證**：確認醫師工作時間和開會時間設定正確
4. **時間同步**：確保系統時間準確

## 測試驗證

### 功能測試腳本

運行測試腳本驗證功能：
```bash
cd backend
python test_meeting_auto_restore.py
```

### 測試覆蓋範圍

✅ **工作時間判斷**：測試正常班次和跨午夜夜班  
✅ **自動下班檢測**：測試過時自動下班功能  
✅ **開會結束恢復**：測試工作時間內自動恢復  
✅ **過期行程清理**：測試下班時間後只清理行程  
✅ **跨午夜處理**：測試夜班時間的正確處理  

### 測試結果範例
```
🧪 開始測試開會自動恢復功能...
============================================================
test_auto_off_duty_past_work_time ✅
test_is_in_work_time_night_shift ✅  
test_is_in_work_time_normal ✅
test_meeting_end_auto_restore_scenario_1 ✅
test_meeting_end_auto_restore_scenario_2 ✅

Ran 5 tests in 0.008s - OK
```

---

**版本**：v2.0  
**最後更新**：2024年12月  
**狀態**：生產就緒 ✅ 