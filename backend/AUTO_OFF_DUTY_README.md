# 醫師自動下班檢測功能

## 功能概述

系統會自動檢測醫師的工作時間，當醫師超過下班時間後，自動將其狀態從「上班」改為「已下班」。

## 功能特點

### 🕐 自動檢測時機
- **定時檢測**：每5分鐘自動檢查一次所有醫師的狀態
- **系統啟動**：系統啟動後10秒自動執行一次檢測
- **手動觸發**：管理員可以手動觸發檢測

### 📋 檢測邏輯

#### 1. 工作時間檢測
- 解析醫師的工作時間（如：`08:00-18:00`）
- 檢查當前時間是否已超過下班時間
- 支援跨午夜的夜班時間（如：`22:00-06:00`）

#### 2. 開會時間檢測
- 如果醫師設定了開會時間，在開會期間自動設為下班狀態
- 開會結束後不會自動恢復上班狀態（需手動處理）

#### 3. 狀態更新條件
- 只有狀態為「上班」(`on_duty`) 的醫師才會被自動設為下班
- 已經是「下班」(`off_duty`) 或「請假」(`off`) 狀態的醫師不受影響

## 技術實現

### 核心服務方法
```python
# 主要檢測方法
DoctorScheduleService.update_doctors_active_status_by_time(db)

# 輔助方法
DoctorScheduleService.parse_work_time(time_str)  # 解析時間字串
DoctorScheduleService._is_past_work_time(current_time, end_time)  # 檢查是否過了下班時間
DoctorScheduleService.is_doctor_in_meeting(meeting_time)  # 檢查是否在開會
```

### 定時任務
- 使用 `APScheduler` 實現定時任務
- 每5分鐘執行一次檢測
- 任務ID: `check_doctors_auto_off_duty`

### API 端點
```
POST /api/doctor-schedules/check-auto-off-duty
```
- 權限：只有護理長和管理員可以手動觸發
- 回應：執行結果和時間戳

## 使用方式

### 自動執行
系統會自動在背景執行，無需人工干預。

### 手動觸發
管理員可以透過 API 手動觸發檢測：

```bash
curl -X POST "http://your-api-url/api/doctor-schedules/check-auto-off-duty" \
  -H "Authorization: Bearer YOUR_TOKEN"
```

## 日誌記錄

系統會記錄以下資訊：
- 檢測開始和結束時間
- 更新的醫師數量和詳細資訊
- 錯誤訊息（如有）

### 日誌範例
```
INFO: 開始檢查醫師自動下班狀態，當前時間: 18:05:00
INFO: 醫師 張醫師 已自動設為下班狀態（工作時間: 08:00-18:00，當前時間: 18:05:00）
INFO: 自動下班檢測完成，已更新 1 位醫師的狀態
```

## 注意事項

### ⚠️ 重要提醒
1. **不會自動恢復上班狀態**：為了安全起見，系統不會自動將醫師從下班狀態改回上班狀態
2. **開會時間優先**：如果醫師在開會，即使在工作時間內也會被設為下班狀態
3. **請假狀態保護**：已請假的醫師不會被自動更改狀態

### 🔧 故障排除
- 如果時間格式不正確，系統會記錄警告但不會影響其他醫師
- 資料庫連接失敗時會自動回滾變更
- 所有錯誤都會記錄在系統日誌中

## 測試驗證

功能已通過完整的單元測試，包括：
- ✅ 工作時間解析
- ✅ 下班時間判斷
- ✅ 跨午夜時間處理
- ✅ 開會時間檢測
- ✅ 邊界條件測試

## 版本資訊

- **版本**：1.0.0
- **實現日期**：2025-06-12
- **相容性**：支援所有現有的醫師班表格式 