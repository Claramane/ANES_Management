# è³‡æ–™åº«è‡ªå‹•åŒæ­¥èªªæ˜

## ğŸ¯ åŠŸèƒ½æ¦‚è¿°

ç³»çµ±å·²æ•´åˆ **APScheduler è‡ªå‹•èƒŒæ™¯åŒæ­¥**ï¼Œå¯¦ç¾æ­£å¼ç’°å¢ƒåˆ°æœ¬åœ°/æ¸¬è©¦ç’°å¢ƒçš„å–®å‘è³‡æ–™åŒæ­¥ã€‚

### âœ… é—œéµç‰¹æ€§

- **ğŸ”„ è‡ªå‹•åŸ·è¡Œ**: ç„¡éœ€æ‰‹å‹•æ“ä½œï¼Œå¾Œç«¯å•Ÿå‹•å³è‡ªå‹•é‹è¡Œ
- **ğŸ“ å–®å‘åŒæ­¥**: æ­£å¼ç’°å¢ƒ (Zeabur) â†’ æœ¬åœ°/æ¸¬è©¦ç’°å¢ƒ
- **â° å®šæœŸæ›´æ–°**: æ¯ 10 åˆ†é˜è‡ªå‹•å¢é‡åŒæ­¥
- **ğŸ”’ å®‰å…¨æ©Ÿåˆ¶**: åªåœ¨æœ¬åœ°/æ¸¬è©¦ç’°å¢ƒå•Ÿå‹•ï¼Œé¿å…å½±éŸ¿æ­£å¼ç’°å¢ƒ
- **ğŸ“Š æ™ºèƒ½å¢é‡**: åªåŒæ­¥è®Šæ›´è³‡æ–™ï¼Œç¯€çœæ™‚é–“å’Œè³‡æº

---

## ğŸ“‹ åŒæ­¥é…ç½®

### åŒæ­¥æ™‚ç¨‹

| äº‹ä»¶ | åŸ·è¡Œæ™‚æ©Ÿ | èªªæ˜ |
|------|---------|------|
| **é¦–æ¬¡åŒæ­¥** | ç³»çµ±å•Ÿå‹•å¾Œ 30 ç§’ | ç¢ºä¿ç’°å¢ƒåˆå§‹åŒ–å¾ŒåŸ·è¡Œ |
| **å®šæœŸåŒæ­¥** | æ¯ 10 åˆ†é˜ | æŒçºŒä¿æŒè³‡æ–™ä¸€è‡´æ€§ |
| **å¢é‡æª¢æ¸¬** | æ¯æ¬¡åŸ·è¡Œ | åŸºæ–¼ `updated_at` åˆ¤æ–·è®Šæ›´ |

### åŒæ­¥æ–¹å‘

```
æ­£å¼ç’°å¢ƒ (Zeabur)          æœ¬åœ°/æ¸¬è©¦ç’°å¢ƒ
   PostgreSQL    â”€â”€â”€â”€â”€â”€â”€â”€â–¶   PostgreSQL
                (å–®å‘åŒæ­¥)
```

**âš ï¸ é‡è¦**:
- âœ… æ­£å¼ç’°å¢ƒçš„è®Šæ›´æœƒè‡ªå‹•åŒæ­¥åˆ°æœ¬åœ°
- âŒ æœ¬åœ°ç’°å¢ƒçš„è®Šæ›´**ä¸æœƒ**å›å¯«åˆ°æ­£å¼ç’°å¢ƒ
- âœ… æœ¬åœ°ä¿®æ”¹æœƒè¢«ä¸‹æ¬¡åŒæ­¥è¦†è“‹ï¼ˆä¿è­·æ­£å¼è³‡æ–™ï¼‰

---

## ğŸš€ å•Ÿå‹•æµç¨‹

### è‡ªå‹•å•Ÿå‹•

ç•¶æ‚¨å•Ÿå‹•å¾Œç«¯æœå‹™æ™‚ï¼š

```bash
cd backend
python main.py
```

æœƒè‡ªå‹•åŸ·è¡Œä»¥ä¸‹æµç¨‹ï¼š

1. âœ… æª¢æŸ¥ç’°å¢ƒï¼ˆ`IS_PRODUCTION`ï¼‰
2. âœ… å¦‚æœæ˜¯æœ¬åœ°/æ¸¬è©¦ç’°å¢ƒ â†’ å•Ÿå‹•åŒæ­¥ä»»å‹™
3. âœ… å¦‚æœæ˜¯æ­£å¼ç’°å¢ƒ â†’ è·³éåŒæ­¥ï¼ˆå–®å‘ä¿è­·ï¼‰
4. âœ… 30 ç§’å¾ŒåŸ·è¡Œé¦–æ¬¡åŒæ­¥
5. âœ… æ¯ 10 åˆ†é˜è‡ªå‹•åŸ·è¡Œå¢é‡åŒæ­¥

### æ—¥èªŒè¼¸å‡º

**å•Ÿå‹•æˆåŠŸ**ï¼š
```
INFO - è³‡æ–™åº«åŒæ­¥å®šæ™‚ä»»å‹™å•Ÿå‹•æˆåŠŸï¼ˆæ­£å¼ç’°å¢ƒ â†’ æœ¬åœ°ï¼Œæ¯10åˆ†é˜åŸ·è¡Œï¼‰
```

**åŒæ­¥åŸ·è¡Œ**ï¼š
```
INFO - é–‹å§‹åŸ·è¡Œè³‡æ–™åº«å¢é‡åŒæ­¥...
INFO - ğŸ“‹ åŒæ­¥è¡¨æ ¼: users
INFO - â„¹ï¸  ç„¡æ–°è³‡æ–™éœ€è¦åŒæ­¥
INFO - è³‡æ–™åº«å¢é‡åŒæ­¥å®Œæˆ
```

**éŒ¯èª¤è™•ç†**ï¼š
```
ERROR - è³‡æ–™åº«åŒæ­¥æ™‚ç™¼ç”ŸéŒ¯èª¤: [è©³ç´°éŒ¯èª¤è¨Šæ¯]
```

---

## ğŸ“Š åŒæ­¥ç¯„åœ

### åŒæ­¥è¡¨æ ¼æ¸…å–®

ä¾ç…§å¤–éµä¾è³´é †åºåŒæ­¥ï¼š

1. âœ… `users` - ä½¿ç”¨è€…è³‡æ–™ï¼ˆæ’é™¤ passwordï¼‰
2. âœ… `formula_schedules` - ç­è¡¨å…¬å¼
3. âœ… `monthly_schedules` - æœˆç­è¡¨
4. âœ… `schedule_versions` - ç­è¡¨ç‰ˆæœ¬
5. âœ… `schedule_version_diffs` - ç‰ˆæœ¬å·®ç•°
6. âœ… `schedule_changes` - ç­è¡¨è®Šæ›´
7. âœ… `shift_swap_requests` - èª¿ç­ç”³è«‹
8. âœ… `overtime_records` - åŠ ç­è¨˜éŒ„
9. âœ… `overtime_points` - åŠ ç­ç©åˆ†
10. âœ… `overtime_monthly_scores` - æœˆåŠ ç­åˆ†æ•¸
11. âœ… `overtime_summaries` - åŠ ç­çµ±è¨ˆ
12. âœ… `announcements` - å…¬å‘Š
13. âœ… `doctor_schedules` - é†«å¸«ç­è¡¨
14. âœ… `day_shift_doctors` - æ—¥ç­é†«å¸«
15. âœ… `doctor_schedule_update_logs` - é†«å¸«ç­è¡¨æ›´æ–°æ—¥èªŒ
16. âš ï¸ `webauthn_credentials` - WebAuthn æ†‘è­‰ï¼ˆæ’é™¤æ•æ„Ÿæ¬„ä½ï¼‰
17. âœ… `logs` - ç³»çµ±æ—¥èªŒ

### æ’é™¤æ¬„ä½

ç‚ºä¿è­·æ•æ„Ÿè³‡æ–™ï¼Œä»¥ä¸‹æ¬„ä½**ä¸æœƒ**åŒæ­¥ï¼š

- `users.password` - ç”¨æˆ¶å¯†ç¢¼
- `webauthn_credentials.credential_id` - ç”Ÿç‰©è¾¨è­˜æ†‘è­‰
- `webauthn_credentials.public_key` - å…¬é‘°è³‡æ–™

---

## ğŸ”§ æŠ€è¡“å¯¦ä½œ

### æª”æ¡ˆçµæ§‹

```
backend/
â”œâ”€â”€ app/
â”‚   â””â”€â”€ tasks/
â”‚       â”œâ”€â”€ db_sync_tasks.py          # åŒæ­¥ä»»å‹™ç®¡ç†å™¨ âœ¨æ–°å¢
â”‚       â””â”€â”€ doctor_schedule_tasks.py  # é†«å¸«ç­è¡¨ä»»å‹™
â”œâ”€â”€ main.py                            # ä¸»æ‡‰ç”¨ç¨‹å¼ (å·²æ•´åˆ)
â””â”€â”€ scripts/
    â”œâ”€â”€ sync_db_incremental.py        # æ ¸å¿ƒåŒæ­¥é‚è¼¯
    â”œâ”€â”€ sync_config.json               # åŒæ­¥é…ç½®
    â””â”€â”€ sync_state.json                # åŒæ­¥ç‹€æ…‹ (è‡ªå‹•ç”Ÿæˆ)
```

### æ ¸å¿ƒä»£ç¢¼

**ä»»å‹™ç®¡ç†å™¨** (`app/tasks/db_sync_tasks.py`):

```python
class DatabaseSyncTaskManager:
    def start_scheduler(self):
        # æ¯10åˆ†é˜åŸ·è¡Œä¸€æ¬¡
        self.scheduler.add_job(
            func=self.sync_database_incremental,
            trigger=IntervalTrigger(minutes=10),
            id='database_sync_incremental',
            name='è³‡æ–™åº«å¢é‡åŒæ­¥ (æ­£å¼ç’°å¢ƒ â†’ æœ¬åœ°)',
            max_instances=1
        )
```

**ä¸»æ‡‰ç”¨ç¨‹å¼æ•´åˆ** (`main.py`):

```python
# åªåœ¨æœ¬åœ°/æ¸¬è©¦ç’°å¢ƒå•Ÿå‹•
if not settings.IS_PRODUCTION:
    db_sync_task_manager.start_scheduler()
    logger.info("è³‡æ–™åº«åŒæ­¥å®šæ™‚ä»»å‹™å•Ÿå‹•æˆåŠŸ")
```

---

## ğŸ“ˆ ç›£æ§èˆ‡ç¶­è­·

### æŸ¥çœ‹åŒæ­¥ç‹€æ…‹

```bash
# æŸ¥çœ‹åŒæ­¥æ­·å²
cat backend/scripts/sync_state.json | python3 -m json.tool

# è¼¸å‡ºç¯„ä¾‹
{
  "users": {
    "last_sync_time": "2025-10-03T14:20:23",
    "records_synced": 0,
    "updated_at": "2025-10-03T14:20:23"
  },
  "doctor_schedules": {
    "last_sync_time": "2025-10-03T14:20:32",
    "records_synced": 114,
    "updated_at": "2025-10-03T14:20:33"
  }
}
```

### æ‰‹å‹•æ¸¬è©¦

```bash
# æ¸¬è©¦è‡ªå‹•åŒæ­¥åŠŸèƒ½
cd backend
python3 test_auto_sync.py
```

### æ‰‹å‹•å…¨é‡åŒæ­¥

å¦‚é‡è³‡æ–™ä¸ä¸€è‡´ï¼Œå¯æ‰‹å‹•åŸ·è¡Œå…¨é‡åŒæ­¥ï¼š

```bash
cd backend/scripts
python3 sync_db_incremental.py --target local --full
```

---

## âš™ï¸ é…ç½®èª¿æ•´

### ä¿®æ”¹åŒæ­¥é »ç‡

ç·¨è¼¯ `app/tasks/db_sync_tasks.py`:

```python
# æ”¹ç‚ºæ¯ 5 åˆ†é˜
trigger=IntervalTrigger(minutes=5)

# æ”¹ç‚ºæ¯å°æ™‚
trigger=IntervalTrigger(hours=1)
```

### åœç”¨è‡ªå‹•åŒæ­¥

ç·¨è¼¯ `app/tasks/db_sync_tasks.py`:

```python
class DatabaseSyncTaskManager:
    def __init__(self):
        self.sync_enabled = False  # æ”¹ç‚º False
```

### æ–°å¢åŒæ­¥è¡¨æ ¼

ç·¨è¼¯ `scripts/sync_config.json`:

```json
{
  "sync_tables": [
    "users",
    "new_table_name",  // åŠ å…¥æ–°è¡¨æ ¼
    ...
  ]
}
```

**âš ï¸ æ³¨æ„**: æ–°å¢è¡¨æ ¼æ™‚éœ€è€ƒæ…®å¤–éµä¾è³´é †åºï¼

---

## ğŸ” æ•…éšœæ’é™¤

### å•é¡Œ 1: åŒæ­¥æœªå•Ÿå‹•

**ç¾è±¡**: å¾Œç«¯å•Ÿå‹•ä½†æ²’æœ‰åŒæ­¥æ—¥èªŒ

**æª¢æŸ¥**:
```bash
# ç¢ºèªç’°å¢ƒè®Šæ•¸
echo $IS_PRODUCTION  # æ‡‰ç‚ºç©ºæˆ– false

# æª¢æŸ¥é…ç½®
cat backend/scripts/sync_config.json
```

**è§£æ±º**:
- ç¢ºä¿ä¸æ˜¯æ­£å¼ç’°å¢ƒ (`IS_PRODUCTION != true`)
- æª¢æŸ¥ `db_sync_tasks.py` ä¸­ `sync_enabled = True`

### å•é¡Œ 2: åŒæ­¥éŒ¯èª¤

**ç¾è±¡**: æ—¥èªŒé¡¯ç¤ºåŒæ­¥å¤±æ•—

**æª¢æŸ¥**:
```bash
# æ¸¬è©¦è³‡æ–™åº«é€£ç·š
python3 backend/scripts/check_replication_support.py

# æ‰‹å‹•åŸ·è¡ŒåŒæ­¥æŸ¥çœ‹è©³ç´°éŒ¯èª¤
python3 backend/scripts/sync_db_incremental.py --target local
```

**å¸¸è¦‹åŸå› **:
- æ­£å¼ç’°å¢ƒè³‡æ–™åº«é€£ç·šå•é¡Œ
- æœ¬åœ°è³‡æ–™åº«æœªåˆå§‹åŒ– (`python init_db.py`)
- è¡¨æ ¼çµæ§‹ä¸ä¸€è‡´

### å•é¡Œ 3: è³‡æ–™ä¸ä¸€è‡´

**ç¾è±¡**: æœ¬åœ°è³‡æ–™èˆ‡æ­£å¼ç’°å¢ƒä¸ç¬¦

**è§£æ±º**:
```bash
# åŸ·è¡Œå…¨é‡åŒæ­¥é‡ç½®
python3 scripts/sync_db_incremental.py --target local --full
```

---

## ğŸ“š ç›¸é—œæ–‡ä»¶

- [QUICK_START.md](QUICK_START.md) - å¿«é€Ÿå…¥é–€æŒ‡å—
- [README_DATABASE_SYNC.md](README_DATABASE_SYNC.md) - å®Œæ•´åŒæ­¥æ‰‹å†Š
- [sync_config.json](sync_config.json) - åŒæ­¥é…ç½®
- [../docs/DATABASE_ARCHITECTURE.md](../../docs/DATABASE_ARCHITECTURE.md) - è³‡æ–™åº«æ¶æ§‹

---

## ğŸ‰ ç¸½çµ

âœ… **å·²å®Œæˆæ•´åˆ**:
- APScheduler è‡ªå‹•èƒŒæ™¯åŒæ­¥
- å–®å‘å®‰å…¨æ©Ÿåˆ¶ï¼ˆæ­£å¼ â†’ æœ¬åœ°ï¼‰
- æ™ºèƒ½å¢é‡åŒæ­¥ï¼ˆåªåŒæ­¥è®Šæ›´ï¼‰
- å®Œæ•´éŒ¯èª¤è™•ç†å’Œæ—¥èªŒ

âœ… **ä½¿ç”¨æ–¹å¼**:
1. å•Ÿå‹•å¾Œç«¯æœå‹™ (`python main.py`)
2. ç³»çµ±è‡ªå‹•é–‹å§‹åŒæ­¥
3. æŸ¥çœ‹ `sync_state.json` ç›£æ§ç‹€æ…‹
4. å¦‚æœ‰éœ€è¦ï¼Œæ‰‹å‹•åŸ·è¡Œå…¨é‡åŒæ­¥

ğŸ”’ **å®‰å…¨ä¿è­‰**:
- åªåœ¨æœ¬åœ°/æ¸¬è©¦ç’°å¢ƒåŸ·è¡Œ
- å–®å‘åŒæ­¥ä¿è­·æ­£å¼ç’°å¢ƒ
- æ•æ„Ÿè³‡æ–™è‡ªå‹•æ’é™¤

---

**æœ€å¾Œæ›´æ–°**: 2025-10-03
**ç‹€æ…‹**: âœ… å·²æ•´åˆä¸¦æ¸¬è©¦é€šé
