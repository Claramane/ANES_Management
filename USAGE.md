# 護理班表管理系統使用指南

## 一、安裝與配置

### 後端設置

1. **安裝依賴**

   ```bash
   cd backend
   pip install -r requirements.txt
   ```

2. **環境配置**

   將 `.env.example` 複製為 `.env` 並根據需要修改其中的配置：

   ```bash
   cp .env.example .env
   ```

3. **初始化數據庫**

   ```bash
   python init_db.py
   ```

   這將創建數據庫表格並添加初始數據，包括：
   - 管理員用戶 (admin/changeme)
   - 測試護理師用戶 (nurse/password)
   - 默認公告分類
   - 默認班別規則

### 前端設置

1. **安裝依賴**

   ```bash
   cd frontend
   npm install
   ```

## 二、啟動應用

### 啟動後端

```bash
cd backend
python run.py
```

### 啟動前端

```bash
cd frontend
npm start
```

系統將在 http://localhost:3000 啟動。

## 三、用戶角色與功能

### 護理長 (admin)

護理長擁有系統的完整管理權限，功能包括：

1. **公式班表管理**
   - 創建/編輯/刪除公式班表
   - 指派護理師至公式班組
   - 設置護理師的公式班循環起始週期

2. **班表管理**
   - 基於公式班表生成月度班表
   - 手動調整班表內容
   - 發布班表，創建版本記錄
   - 控制護理師順序（**在用戶管理介面，可調整不同「身份」護理師的預設顯示順序；在排班相關頁面，人員列表將主要依「身份」權重排序**）

3. **用戶管理**
   - 創建/編輯/刪除用戶
   - 設置用戶角色與身份

4. **公告管理**
   - 發布各類公告
   - 設置公告分類
   - 設置不同身份的發布權限

5. **系統設置**
   - 設置班別規則（工作時間、最小休息時間等）
   - 配置公告分類權限

### 護理師 (nurse)

護理師可以使用以下功能：

1. **班表查詢**
   - 查看個人週班表
   - 查看月班表（**恢復室等特定身份人員會根據預設身份權重排序**）
   - 查看大班表（所有人員，**排序方式同月班表**）

2. **換班功能**
   - **提交換班申請**：
     - 選擇自己要換出的日期、班別。
     - 選擇希望換入的日期、班別。
     - 可選擇特定同事進行交換，或開放給所有符合資格的同事。
     - 提交前系統會初步檢查班別的合法性。
   - **處理換班請求**：
     - 查看他人向自己發起的換班請求。
     - 接受或拒絕請求。接受前，系統會再次進行嚴格的工時規則驗證，確保雙方換班後均符合規定（如班次間隔、連續工作時數等）。
   - **查看換班狀態與歷史**：
     - 追蹤自己發起或收到的換班請求狀態（待處理、已接受、已拒絕、已取消、已過期）。
     - 瀏覽所有換班操作的歷史紀錄。

3. **公告查看**
   - 瀏覽所有公告
   - 在有權限的分類下發布公告（默認僅「閒聊」分類）

## 四、基本操作流程

### 班表管理流程（護理長）

1. **設置公式班表**
   - 創建多個公式班組（如週一到週日的班別組合）
   - 將護理師指派到特定公式班組
   - 設置循環起始週期

2. **生成月度班表**
   - 選擇年月，生成月度班表
   - 審核並根據需要調整生成的班表
   - 發布班表，生成版本快照

### 換班申請流程（護理師）

1. **提交換班申請**
   - 登入系統後，進入「換班管理」頁面。
   - 點擊「發起換班」或類似按鈕。
   - **第一步：選擇我的班務**
     - 選擇要換出的日期。
     - 系統會顯示您當日的班別、任務（如適用）。點選要換出的班務。
   - **第二步：選擇期望班務**
     - 選擇期望換入的日期。
     - 選擇期望換入的班別（例如 A班、N班等）。
     - （可選）選擇期望換入的任務/區域。
   - **第三步：選擇換班對象**
     - 您可以選擇一位特定的護理師作為換班對象。
     - 或者，您可以不指定特定對象，將請求開放給所有符合條件的護理師。
   - **第四步：備註與提交**
     - （可選）填寫換班原因或備註。
     - 提交申請。系統會進行初步的規則檢查。

2. **接受/拒絕換班申請**
   - 在「換班管理」頁面，切換到「待我處理」或類似的列表。
   - 系統會列出其他護理師向您發起或指定給您的換班請求。
   - 對於每個請求，您可以查看詳細的換班內容（對方想用什麼班換您的什麼班）。
   - **點擊「接受」**：系統將執行嚴格的班別規則驗證（檢查雙方在交換後的班表是否符合工時規定、休息時間等）。如果驗證通過，換班成功，雙方班表將自動更新。如果驗證失敗，系統會提示原因，換班無法完成。
   - **點擊「拒絕」**：對方會收到拒絕通知。

## 五、注意事項

1. **IP限制**：護理長帳號採用IP限制，同一時間只允許從一個IP地址登入。

2. **換班規則**：系統會根據預設的班別規則（如特定班別組合的最小間隔時間 `INVALID_SHIFT_COMBINATIONS`，各班別的標準工作時段 `SHIFT_TIME_RANGES`）自動驗證換班申請的合法性，以確保符合勞基法及內部工時規定。例如，N班後接A班需要足夠的休息時間。

3. **版本控制**：每次發布班表會創建一個新版本，保留修改歷史，可進行版本比對。

4. **數據備份**：正式環境建議定期備份數據庫，確保數據安全。

## 六、默認帳號信息

1. **護理長**
   - 用戶名：admin
   - 密碼：changeme（首次登入後建議修改）

2. **測試護理師**
   - 用戶名：nurse
   - 密碼：password

## v0.9.0 更新：Passkey設備綁定限制

### 一台設備一個帳號原則
從v0.9.0開始，系統實施了嚴格的設備綁定限制：
- **一台設備只能綁定一個帳號**：每個物理設備（根據設備指紋識別）只能為一個用戶帳號註冊Passkey
- **設備指紋技術**：系統會根據設備的瀏覽器、作業系統等穩定特徵生成唯一指紋
- **安全防護**：防止同一設備被多個帳號濫用，提升系統安全性

### 設備綁定限制的運作方式

#### 註冊階段
1. 當用戶嘗試註冊Passkey時，系統會檢查該設備是否已被其他帳號綁定
2. 如果設備已被綁定，會顯示錯誤訊息：「此設備已經綁定到其他帳號。一台設備只能綁定一個帳號。」
3. 只有未被綁定的設備才能成功註冊Passkey

#### 登入階段
- 用戶可以用帳號密碼正常登入任何設備
- Passkey登入只能在已註冊該帳號的設備上進行
- 系統會在登入頁面顯示可用的Passkey選項

#### 解除綁定
要讓設備綁定到新帳號，需要：
1. **原綁定用戶**登入系統
2. 進入「系統設定」→「Passkey管理」
3. 刪除該設備的Passkey
4. 新用戶才能在該設備上註冊Passkey

### 使用建議
- **個人設備**：在個人電腦、手機等私人設備上註冊Passkey，享受便利的無密碼登入
- **共用設備**：在辦公室共用電腦等設備上，建議使用傳統帳號密碼登入
- **多設備支援**：同一用戶可以在多台不同設備上註冊Passkey（如個人手機、平板、家用電腦等）
- **備用方案**：建議至少保留一組Passkey，並確保能使用帳號密碼作為備用登入方式

## v0.8.8 新功能：Passkey（WebAuthn）無密碼登入/管理

### 什麼是Passkey？
- Passkey是一種基於FIDO2/WebAuthn標準的無密碼登入方式，支援生物辨識（如指紋、Face ID）或PIN驗證。
- 更安全：無需密碼，降低被盜風險，生物辨識資料不會離開裝置。
- 更便利：一鍵登入，無需記憶密碼，可跨多裝置註冊與使用。
- 隱私保護：所有驗證資料僅儲存於本地裝置。

### 如何註冊Passkey
1. 登入系統後，進入「系統設定」頁面。
2. 在「Passkey管理」區塊，點擊「註冊新的Passkey」。
3. 按照瀏覽器指示，使用裝置的生物辨識（如指紋、Face ID）或PIN完成註冊。
4. 註冊成功後，Passkey會顯示於列表中。

### 如何使用Passkey登入
1. 在登入頁選擇「Passkey登入」或相關按鈕。
2. 按照瀏覽器指示，使用已註冊裝置的生物辨識或PIN驗證。
3. 驗證成功後自動登入系統。

### Passkey管理與刪除
- 所有Passkey管理功能（查看、註冊、刪除）已整合至「系統設定」頁面。
- 點擊Passkey列表可展開詳細資訊，刪除時會有多重警告與詳細資訊提示。
- 建議至少保留一組Passkey，避免無法登入。

### 注意事項
- Passkey僅儲存於註冊裝置，若裝置遺失需重新註冊。
- 若刪除所有Passkey，請確保記得密碼以便後續登入。
- 支援多裝置註冊與管理。 