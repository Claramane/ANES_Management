# 統一分數導向加班分配算法 - 更新總結

## 🎯 更新目標

將原有的隨機分配算法升級為**統一分數導向算法**，實現最大化零分接近度的公平分配。

## ✅ 完成的更新

### 1. 分數系統升級

**舊系統**：
- A班: 1.2分
- B班: 0.7分  
- C班: 0.6分
- D班: 0.2分
- E/F班: 0.0分

**新系統**：
- A班: 2.0分（價值是B班的2倍）
- B班: 1.0分（基準分數）
- C班: 0.8分（略低於B班）
- D班: 0.3分（低分值班別）
- E/F班: 0.0分（零分）
- **未加班白班: -0.196分**（新增負分平衡機制）

### 2. 核心算法升級

**舊算法（隨機方式）**：
- 隨機打亂所有人員
- 最多嘗試10,000次找到平衡分配
- 容易出現不公平情況

**新算法（統一分數導向）**：
- 所有班別都按**分數最低優先**原則分配
- 兩階段分配：平日（A-F各一人） + 週六（僅A班）
- 高分班別（A、B）考慮間隔時間（≥7天）
- 確保最大化零分接近度

### 3. 前端界面更新

**按鈕文字**：
- "隨機生成" → "智能分配"
- "生成中..." → "分配中..."

**對話框描述**：
- 更新為"統一分數導向算法"說明
- 添加新分數系統的詳細說明
- 說明"分數最低優先原則"

**提示文字**：
- 添加智能分配算法的說明
- 明確零分接近度目標

### 4. 算法功能

**全部重新智能分配**：
- 清空所有現有分配
- 使用統一分數導向算法重新分配
- 確保最佳平衡效果

**智能補齊未分配班別**：
- 保留現有分配
- 只對未分配的班別使用算法
- 維持部分手動調整的彈性

## 🔧 技術實現細節

### 選擇邏輯優先級

1. **分數最低優先**：當前分數最低的人優先獲得班別
2. **分數相近處理**：在±0.3分誤差內的人中進一步篩選
3. **間隔時間考慮**：A、B班確保至少間隔7天
4. **班別數量平衡**：在分數相近時考慮已有班別數量

### 基礎分數計算

- 根據用戶ID模擬不同出勤率（70%-95%）
- 白班天數 × 未加班負分(-0.196)
- 確保長期分數平衡

### 分配流程

1. 收集所有參與人員（排除麻醉科Leader）
2. 初始化基礎分數
3. 平日分配：按A→B→C→D→E→F順序分配
4. 週六分配：只分配A班
5. 實時更新分數並選擇最佳人選

## 📊 預期效果

### 分數分布改善

**舊系統**：
- 容易出現極端分數差異
- 部分人可能獲得3個A班，部分人沒有
- 分數範圍可能很大

**新系統**：
- 所有人分數接近零分
- 分數範圍控制在2分以內
- 確保每人至少1個A班（當A班充足時）

### 公平性提升

- **分數最低優先**：最需要正分的人優先獲得高分班別
- **間隔時間控制**：避免連續密集的高強度班別
- **零分中心化**：長期多月後所有人分數震盪在零分附近

### 用戶體驗改善

- **智能化**：從"隨機"升級為"智能"
- **可預測**：分配結果符合公平邏輯
- **透明度**：用戶了解分配依據和目標

## 🎯 邊界情況處理

### A班過多時
- 每人先分配1個A班
- 剩餘A班按分數+間隔原則分配
- 確保間隔至少7天

### A班不足時
- 按分數從低到高分配
- 沒分到A班的是分數最接近零分的人
- 這樣的結果是合理的（他們不太需要正分）

## 🔄 向後兼容

- 保留原有的手動標記功能
- 保留重設功能
- API接口無變化
- 數據格式無變化

## 📝 總結

這次更新將隨機分配升級為科學的統一分數導向算法，實現了：

✅ **公平性最大化**：分數最低優先確保公平  
✅ **零分接近度**：長期平衡分數分布  
✅ **智能化分配**：科學算法替代隨機方式  
✅ **用戶體驗提升**：界面更直觀，說明更清楚  
✅ **向後兼容**：不影響現有功能和數據  

新算法確保了麻醉科護理班表管理系統的加班分配更加公平、合理和可預測！